(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function r(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(n){if(n.ep)return;n.ep=!0;const l=r(n);fetch(n.href,l)}})();let w=Object.getPrototypeOf,D,I,p,E,Q={isConnected:1},me=1e3,x,R={},pe=w(Q),Z=w(w),F,ee=(e,t,r,o)=>(e??(setTimeout(r,o),new Set)).add(t),te=(e,t,r)=>{let o=p;p=t;try{return e(r)}catch(n){return console.error(n),r}finally{p=o}},T=e=>e.filter(t=>{var r;return(r=t._dom)==null?void 0:r.isConnected}),re=e=>x=ee(x,e,()=>{for(let t of x)t._bindings=T(t._bindings),t._listeners=T(t._listeners);x=F},me),V={get val(){var e;return(e=p==null?void 0:p._getters)==null||e.add(this),this.rawVal},get oldVal(){var e;return(e=p==null?void 0:p._getters)==null||e.add(this),this._oldVal},set val(e){var t;(t=p==null?void 0:p._setters)==null||t.add(this),e!==this.rawVal&&(this.rawVal=e,this._bindings.length+this._listeners.length?(I==null||I.add(this),D=ee(D,this,he)):this._oldVal=e)}},oe=e=>({__proto__:V,rawVal:e,_oldVal:e,_bindings:[],_listeners:[]}),C=(e,t)=>{let r={_getters:new Set,_setters:new Set},o={f:e},n=E;E=[];let l=te(e,r,t);l=(l??document).nodeType?l:new Text(l);for(let a of r._getters)r._setters.has(a)||(re(a),a._bindings.push(o));for(let a of E)a._dom=l;return E=n,o._dom=l},N=(e,t=oe(),r)=>{let o={_getters:new Set,_setters:new Set},n={f:e,s:t};n._dom=r??(E==null?void 0:E.push(n))??Q,t.val=te(e,o,t.rawVal);for(let l of o._getters)o._setters.has(l)||(re(l),l._listeners.push(n));return t},ne=(e,...t)=>{for(let r of t.flat(1/0)){let o=w(r??0),n=o===V?C(()=>r.val):o===Z?C(r):r;n!=F&&e.append(n)}return e},le=(e,t,...r)=>{var s;let[{is:o,...n},...l]=w(r[0]??0)===pe?r:[{},...r],a=e?document.createElementNS(e,t,{is:o}):document.createElement(t,{is:o});for(let[f,u]of Object.entries(n)){let h=k=>k?Object.getOwnPropertyDescriptor(k,f)??h(w(k)):F,y=t+","+f,i=R[y]??(R[y]=((s=h(w(a)))==null?void 0:s.set)??0),_=f.startsWith("on")?(k,fe)=>{let G=f.slice(2);a.removeEventListener(G,fe),a.addEventListener(G,k)}:i?i.bind(a):a.setAttribute.bind(a,f),m=w(u??0);f.startsWith("on")||m===Z&&(u=N(u),m=V),m===V?C(()=>(_(u.val,u._oldVal),a)):_(u)}return ne(a,l)},H=e=>({get:(t,r)=>le.bind(F,e,r)}),ae=(e,t)=>t?t!==e&&e.replaceWith(t):e.remove(),he=()=>{let e=0,t=[...D].filter(o=>o.rawVal!==o._oldVal);do{I=new Set;for(let o of new Set(t.flatMap(n=>n._listeners=T(n._listeners))))N(o.f,o.s,o._dom),o._dom=F}while(++e<100&&(t=[...I]).length);let r=[...D].filter(o=>o.rawVal!==o._oldVal);D=F;for(let o of new Set(r.flatMap(n=>n._bindings=T(n._bindings))))ae(o._dom,C(o.f,o._dom)),o._dom=F;for(let o of r)o._oldVal=o.rawVal};const d={tags:new Proxy(e=>new Proxy(le,H(e)),H()),hydrate:(e,t)=>ae(e,C(t,e)),add:ne,state:oe,derive:N},ye="modulepreload",be=function(e){return"/"+e},J={},we=function(t,r,o){let n=Promise.resolve();if(r&&r.length>0){let a=function(u){return Promise.all(u.map(h=>Promise.resolve(h).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),f=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));n=a(r.map(u=>{if(u=be(u),u in J)return;J[u]=!0;const h=u.endsWith(".css"),y=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${y}`))return;const i=document.createElement("link");if(i.rel=h?"stylesheet":ye,h||(i.as="script"),i.crossOrigin="",i.href=u,f&&i.setAttribute("nonce",f),document.head.appendChild(i),h)return new Promise((_,m)=>{i.addEventListener("load",_),i.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${u}`)))})}))}function l(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return n.then(a=>{for(const s of a||[])s.status==="rejected"&&l(s.reason);return t().catch(l)})};function ve(e={}){const{immediate:t=!1,onNeedRefresh:r,onOfflineReady:o,onRegistered:n,onRegisteredSW:l,onRegisterError:a}=e;let s,f,u;const h=async(i=!0)=>{await f,u==null||u()};async function y(){if("serviceWorker"in navigator){if(s=await we(async()=>{const{Workbox:i}=await import("./workbox-window.prod.es5-CwtvwXb3.js");return{Workbox:i}},[]).then(({Workbox:i})=>new i("/sw.js",{scope:"/",type:"classic"})).catch(i=>{a==null||a(i)}),!s)return;u=()=>{s==null||s.messageSkipWaiting()};{let i=!1;const _=()=>{i=!0,s==null||s.addEventListener("controlling",m=>{m.isUpdate&&window.location.reload()}),r==null||r()};s.addEventListener("installed",m=>{typeof m.isUpdate>"u"?typeof m.isExternal<"u"&&m.isExternal?_():!i&&(o==null||o()):m.isUpdate||o==null||o()}),s.addEventListener("waiting",_)}s.register({immediate:t}).then(i=>{l?l("/sw.js",i):n==null||n(i)}).catch(i=>{a==null||a(i)})}}return f=y(),h}const S=d.state(localStorage.getItem("debugMode")==="true"||window.location.hash==="#debug"),A=d.state(!1),O=d.state([]),_e=200,Se={log:console.log,error:console.error,warn:console.warn,info:console.info};function se(e,t){const r=new Date().toLocaleTimeString(),o=t.map(l=>{if(typeof l=="object")try{return JSON.stringify(l,null,2)}catch{return String(l)}return String(l)}).join(" "),n=[...O.val,{timestamp:r,level:e,message:o}];n.length>_e&&n.shift(),O.val=n}["log","error","warn","info"].forEach(e=>{console[e]=function(...t){Se[e].apply(console,t),se(e,t)}});var K;(K=navigator.serviceWorker)==null||K.addEventListener("message",e=>{e.data&&e.data.type==="SW_LOG"&&se(e.data.level,[e.data.message])});function L(e){if(console.error(e),S.val)throw e}function q(e,t={}){const r=e instanceof Error?`${e.name}: ${e.message}

${e.stack||""}`:String(e),o=["context","filename","lineno","colno","reason"].filter(n=>t[n]).map(n=>`${n}: ${t[n]}`).join(`
`);document.body.innerHTML=`<pre style="background:white;color:black;padding:20px;margin:0;white-space:pre-wrap;height:100%;overflow:auto;font-family:monospace">APPLICATION ERROR

${r}

${o}</pre>`}window.onerror=function(e,t,r,o,n){return q(n||new Error(e),{filename:t,lineno:r,colno:o,message:e}),!0};window.addEventListener("unhandledrejection",function(e){q(e.reason instanceof Error?e.reason:new Error(String(e.reason)),{reason:e.reason,promise:e.promise}),e.preventDefault()});let ie=()=>Promise.resolve(!1);"serviceWorker"in navigator&&window.addEventListener("load",()=>{ie=ve({immediate:!1,onRegistered(){console.log("Service worker registered")},onRegisterError(e){console.error("Service worker registration error:",e)}})});const{div:c,header:Ee,main:Fe,aside:$e,h1:Le,h2:ce,button:b,input:Pe,label:ke,span:j,dialog:Ae,ul:De,li:Ie,p:Oe,a:de,img:Ce}=d.tags,g=d.state([]),U=d.state(!1),$=d.state(!0),W=d.state(!1),v=new Map;function Ue(e){if(!v.has(e.id)){const t=URL.createObjectURL(e.file);v.set(e.id,t),console.log(`Created blob URL for ${e.id}`)}return v.get(e.id)}function Be(e){v.has(e)&&(URL.revokeObjectURL(v.get(e)),v.delete(e),console.log(`Released blob URL for ${e}`))}function B(){return new Promise((e,t)=>{if(!("indexedDB"in window))return t(new Error("IndexedDB is not supported"));console.log("Opening IndexedDB...");const r=indexedDB.open("localfilesDB",2);r.onupgradeneeded=o=>{console.log("Database upgrade needed");const n=o.target.result;n.objectStoreNames.contains("mediaFiles")||(n.createObjectStore("mediaFiles",{keyPath:"id"}),console.log("Created mediaFiles store")),n.objectStoreNames.contains("sharedFiles")||(n.createObjectStore("sharedFiles",{keyPath:"id"}),console.log("Created sharedFiles store"))},r.onsuccess=o=>{console.log("IndexedDB opened successfully"),e(o.target.result)},r.onerror=o=>{console.error("IndexedDB error:",o.target.error),alert(`Database error: ${o.target.error.message}`),t(o.target.error)}})}function P(e,t,r,o){return new Promise((n,l)=>{if(!e)return l(new Error("Database not initialized"));const a=o(e.transaction(t,r).objectStore(t));a.onsuccess=()=>n(a.result),a.onerror=s=>l(s.target.error)})}const xe=(e,t,r)=>P(e,"mediaFiles","readwrite",o=>o.put({id:t,blob:r})),je=(e,t)=>P(e,"mediaFiles","readonly",r=>r.get(t)).then(r=>r?r.blob:null),Te=(e,t)=>P(e,"mediaFiles","readwrite",r=>r.delete(t)),Ve=e=>P(e,"mediaFiles","readwrite",t=>t.clear()),Me=e=>P(e,"sharedFiles","readonly",t=>t.getAll()).then(t=>t||[]),Re=e=>P(e,"sharedFiles","readwrite",t=>t.clear());async function X(){try{const e=await B(),t=await Me(e);return t.length===0?!1:(console.log(`Processing ${t.length} shared files`),await ge(t.map(r=>r.file)),await Re(e),alert(`${t.length} shared file(s) added to your library!`),!0)}catch(e){return console.error("Error processing shared files:",e),L(e),!1}}const ue="localFilesAppMetadata";function We(){try{return JSON.parse(localStorage.getItem(ue))||[]}catch{return[]}}function M(e){try{localStorage.setItem(ue,JSON.stringify(e.map(({file:t,...r})=>r)))}catch(t){t.name==="QuotaExceededError"&&alert("Storage full. Clear some browser data.")}}const Ne=async()=>{try{$.val=!0,console.log("Loading data...");const e=await B(),t=We();console.log(`Found ${t.length} files in metadata`);const r=(await Promise.all(t.map(async o=>{const n=await je(e,o.id);return n?{...o,file:n}:null}))).filter(Boolean);g.val=r,console.log(`Loaded ${r.length} files`),$.val=!1}catch(e){console.error("Error loading data:",e),L(e),$.val=!1}};async function ge(e){if(!(e!=null&&e.length))return;const t=1e3*1024*1024,r=await B(),o=[];for(let n=0;n<e.length;n++){const l=e[n];if(console.log(`Processing file ${n+1}/${e.length}: ${l.name}`),l.size>t){alert(`File ${l.name} exceeds 1000MB limit.`);continue}const a={id:`file-${Date.now()}-${n}`,name:l.name||`shared-${Date.now()}-${n}`,type:l.type,size:l.size,file:l,progress:0,dateAdded:new Date().toISOString()};try{await xe(r,a.id,a.file),console.log(`Stored ${a.name} in IndexedDB`),o.push(a)}catch(s){console.error("Error storing file in IndexedDB:",s),L(s),alert(`Could not save ${a.name}`)}}if(o.length>0){console.log(`Adding ${o.length} files to library`);const n=[...g.val,...o];g.val=n,M(n),U.val=!0,alert(`${o.length} files uploaded!`),setTimeout(()=>z(o[0]),500)}}function z(e){var t;console.log("Playing file:",e.name);try{const r=document.getElementById("media-player");if(!r)return console.error("Media player element not found"),alert("Media player not found. Refresh the page.");document.getElementById("video-container").style.display="block",(t=document.querySelector(".upload-prompt"))==null||t.style.setProperty("display","none");const o=e.file instanceof File?Ue(e):e.data;if(!o)return console.error("File has no playable source:",e),alert(`Cannot play ${e.name}: Invalid source`);console.log(`Setting player source to: ${o.substring(0,50)}...`),r.src=o,r.setAttribute("data-current-file-id",e.id),e.progress&&(r.currentTime=e.progress),window.innerWidth<768&&(U.val=!1),setTimeout(()=>{r.play().then(()=>{console.log(`Playing ${e.name}`),localStorage.setItem("lastPlayedFileId",e.id)}).catch(console.error)},300)}catch(r){L(r),alert(`Error playing file: ${r.message}`)}}async function qe(e){console.log(`Deleting file: ${e}`),Be(e);try{const r=await B();await Te(r,e),console.log(`Removed ${e} from IndexedDB`)}catch(r){console.error("Error removing file from IndexedDB:",r),L(r)}const t=g.val.filter(r=>r.id!==e);g.val=t,M(t)}function ze(){document.getElementById("confirm-dialog").showModal()}async function Ge(){console.log("Deleting all files"),v.forEach(e=>URL.revokeObjectURL(e)),v.clear();try{await Ve(await B()),console.log("Cleared all files from IndexedDB")}catch(e){console.error("Error clearing IndexedDB:",e),L(e)}M([]),g.val=[],document.getElementById("confirm-dialog").close()}function He(){document.getElementById("confirm-dialog").close()}async function Je(){console.log("Checking for updates..."),W.val=!0,await ie(!0).catch(e=>console.error("Update error:",e)),window.location.reload()}function Y(e,t){const r=g.val.map(o=>o.id===e?{...o,progress:t}:o);g.val=r,M(r)}function Xe(){return $e({class:d.derive(()=>`sidebar ${U.val?"open":""}`)},ce({},"Your Files"),d.derive(()=>$.val?c({class:"loading-message"},"Loading files..."):g.val.length===0?c({class:"empty-message"},"No files added yet"):c({},De({},...g.val.map(e=>Ie({class:"file-item"},j({onclick:()=>z(e),class:"file-name"},e.name||"Unnamed"),b({class:"delete-btn outline",onclick:t=>{t.stopPropagation(),qe(e.id)}},"×")))),b({class:"delete-all-btn outline",onclick:ze},"Delete All"))),c({class:"sidebar-footer"},c({class:"sidebar-footer-buttons"},b({class:d.derive(()=>`debug-toggle ${S.val?"active":""}`),onclick:()=>{S.val=!S.val,localStorage.setItem("debugMode",S.val)}},d.derive(()=>S.val?"Debug: ON":"Debug: OFF")),b({class:"force-update-btn",onclick:Je,disabled:d.derive(()=>W.val)},d.derive(()=>W.val?"Checking...":"Check for Updates"))),de({href:"https://github.com/netanel-haber/localfiles.stream/commit/467be39bb6f2f5b3c8387527fb3d275168309649",target:"_blank",class:"commit-link"},"467be39bb6f2f5b3c8387527fb3d275168309649".substring(0,7))))}function Ye(){return Ee({},c(b({class:"hamburger outline",onclick:()=>U.val=!U.val},"☰"),Le({},"localfiles.stream"),c({class:"github-link"},de({href:"https://github.com/netanel-haber/localfiles.stream",target:"_blank"},Ce({src:"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",alt:"GitHub"})))),c(ke({class:"upload-btn",for:"file-upload"},"Upload Files"),Pe({type:"file",id:"file-upload",accept:"audio/*,video/*",multiple:!0,style:"display: none",onchange:async e=>{var t;(t=e.target.files)!=null&&t.length&&await ge(e.target.files),e.target.value=""}})))}function Ke(){return c({class:"media-container"},c({class:"player-wrapper"},c({class:"upload-prompt",style:d.derive(()=>!$.val&&g.val.length===0?"display: flex":"display: none")},"Upload media files to start playing"),c({class:"loading-indicator",style:d.derive(()=>$.val?"display: flex":"display: none")},"Loading your media files..."),c({id:"video-container",class:"video-container",style:"display: none;"},c({class:"media-element-container"},d.tags.video({id:"media-player",controls:!0,playsinline:!0,ontimeupdate:e=>{const t=e.target.getAttribute("data-current-file-id");t&&Y(t,e.target.currentTime)},onended:e=>{const t=e.target.getAttribute("data-current-file-id");t&&Number.isFinite(e.target.duration)&&Y(t,e.target.duration),e.target.removeAttribute("data-current-file-id")},onerror:e=>{var t;alert(`Error playing: ${((t=e.target.error)==null?void 0:t.message)||"Unknown error"}`),e.target.removeAttribute("data-current-file-id")}})))),Ze())}function Qe(){return Ae({id:"confirm-dialog"},c({class:"dialog-content"},ce({},"Confirm Deletion"),Oe({},"Are you sure you want to delete all files?"),c({class:"dialog-buttons"},b({onclick:He,class:"secondary"},"Cancel"),b({onclick:Ge},"Delete All"))))}function Ze(){return c({class:d.derive(()=>`console-viewer ${S.val?"":"hidden"} ${A.val?"open":"closed"}`)},c({class:"console-header"},d.derive(()=>j({},`Console (${O.val.length})`)),c({class:"console-controls"},b({class:"console-btn",onclick:()=>O.val=[]},"Clear"),b({class:"console-btn",onclick:()=>A.val=!A.val},d.derive(()=>A.val?"▼":"▲")))),d.derive(()=>A.val?(setTimeout(()=>{const e=document.getElementById("console-logs-container");e&&(e.scrollTop=e.scrollHeight)},10),c({class:"console-logs",id:"console-logs-container"},...O.val.map(e=>c({class:`console-entry console-${e.level}`},j({class:"console-timestamp"},e.timestamp),j({class:"console-level"},e.level.toUpperCase()),d.tags.pre({class:"console-message"},e.message))))):c({class:"console-logs",style:"display: none;"})))}function et(){return c({id:"layout"},Ye(),c({class:"content"},Xe(),Fe({},Ke())),Qe())}(async()=>{console.log("Initializing app..."),d.add(document.getElementById("app"),et()),await Ne();const e=new URLSearchParams(window.location.search);if(e.get("shared")==="true")console.log("Processing shared files from URL param"),await X(),window.history.replaceState({},document.title,window.location.pathname);else if(e.get("error")==="share_failed"){console.error("Share operation failed");const o=new Error(e.get("error_msg")||"Share failed");o.name=e.get("error_name")||"ShareError",q(o,{context:"Android share"}),window.history.replaceState({},document.title,window.location.pathname)}else await X();console.log(`App initialized with ${g.val.length} files`);const t=localStorage.getItem("lastPlayedFileId"),r=t&&g.val.find(o=>o.id===t);r&&(console.log(`Auto-playing last file: ${r.name}`),z(r))})();
