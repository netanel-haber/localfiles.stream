(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function a(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(r){if(r.ep)return;r.ep=!0;const n=a(r);fetch(r.href,n)}})();let h=Object.getPrototypeOf,D,L,m,S,N={isConnected:1},oe=1e3,$,k={},re=h(N),R=h(h),_,G=(e,t,a,o)=>(e??(setTimeout(a,o),new Set)).add(t),J=(e,t,a)=>{let o=m;m=t;try{return e(a)}catch(r){return console.error(r),a}finally{m=o}},x=e=>e.filter(t=>{var a;return(a=t._dom)==null?void 0:a.isConnected}),Q=e=>$=G($,e,()=>{for(let t of $)t._bindings=x(t._bindings),t._listeners=x(t._listeners);$=_},oe),O={get val(){var e;return(e=m==null?void 0:m._getters)==null||e.add(this),this.rawVal},get oldVal(){var e;return(e=m==null?void 0:m._getters)==null||e.add(this),this._oldVal},set val(e){var t;(t=m==null?void 0:m._setters)==null||t.add(this),e!==this.rawVal&&(this.rawVal=e,this._bindings.length+this._listeners.length?(L==null||L.add(this),D=G(D,this,ae)):this._oldVal=e)}},X=e=>({__proto__:O,rawVal:e,_oldVal:e,_bindings:[],_listeners:[]}),I=(e,t)=>{let a={_getters:new Set,_setters:new Set},o={f:e},r=S;S=[];let n=J(e,a,t);n=(n??document).nodeType?n:new Text(n);for(let l of a._getters)a._setters.has(l)||(Q(l),l._bindings.push(o));for(let l of S)l._dom=n;return S=r,o._dom=n},T=(e,t=X(),a)=>{let o={_getters:new Set,_setters:new Set},r={f:e,s:t};r._dom=a??(S==null?void 0:S.push(r))??N,t.val=J(e,o,t.rawVal);for(let n of o._getters)o._setters.has(n)||(Q(n),n._listeners.push(r));return t},Y=(e,...t)=>{for(let a of t.flat(1/0)){let o=h(a??0),r=o===O?I(()=>a.val):o===R?I(a):a;r!=_&&e.append(r)}return e},Z=(e,t,...a)=>{var i;let[{is:o,...r},...n]=h(a[0]??0)===re?a:[{},...a],l=e?document.createElementNS(e,t,{is:o}):document.createElement(t,{is:o});for(let[d,c]of Object.entries(r)){let p=P=>P?Object.getOwnPropertyDescriptor(P,d)??p(h(P)):_,y=t+","+d,s=k[y]??(k[y]=((i=p(h(l)))==null?void 0:i.set)??0),F=d.startsWith("on")?(P,te)=>{let V=d.slice(2);l.removeEventListener(V,te),l.addEventListener(V,P)}:s?s.bind(l):l.setAttribute.bind(l,d),g=h(c??0);d.startsWith("on")||g===R&&(c=T(c),g=O),g===O?I(()=>(F(c.val,c._oldVal),l)):F(c)}return Y(l,n)},z=e=>({get:(t,a)=>Z.bind(_,e,a)}),H=(e,t)=>t?t!==e&&e.replaceWith(t):e.remove(),ae=()=>{let e=0,t=[...D].filter(o=>o.rawVal!==o._oldVal);do{L=new Set;for(let o of new Set(t.flatMap(r=>r._listeners=x(r._listeners))))T(o.f,o.s,o._dom),o._dom=_}while(++e<100&&(t=[...L]).length);let a=[...D].filter(o=>o.rawVal!==o._oldVal);D=_;for(let o of new Set(a.flatMap(r=>r._bindings=x(r._bindings))))H(o._dom,I(o.f,o._dom)),o._dom=_;for(let o of a)o._oldVal=o.rawVal};const b={tags:new Proxy(e=>new Proxy(Z,z(e)),z()),hydrate:(e,t)=>H(e,I(t,e)),add:Y,state:X,derive:T},ne="modulepreload",le=function(e){return"/"+e},W={},ie=function(t,a,o){let r=Promise.resolve();if(a&&a.length>0){let l=function(c){return Promise.all(c.map(p=>Promise.resolve(p).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),d=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));r=l(a.map(c=>{if(c=le(c),c in W)return;W[c]=!0;const p=c.endsWith(".css"),y=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${y}`))return;const s=document.createElement("link");if(s.rel=p?"stylesheet":ne,p||(s.as="script"),s.crossOrigin="",s.href=c,d&&s.setAttribute("nonce",d),document.head.appendChild(s),p)return new Promise((F,g)=>{s.addEventListener("load",F),s.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(l){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=l,window.dispatchEvent(i),!i.defaultPrevented)throw l}return r.then(l=>{for(const i of l||[])i.status==="rejected"&&n(i.reason);return t().catch(n)})};function se(e={}){const{immediate:t=!1,onNeedRefresh:a,onOfflineReady:o,onRegistered:r,onRegisteredSW:n,onRegisterError:l}=e;let i,d,c;const p=async(s=!0)=>{await d,c==null||c()};async function y(){if("serviceWorker"in navigator){if(i=await ie(async()=>{const{Workbox:s}=await import("./workbox-window.prod.es5-B9K5rw8f.js");return{Workbox:s}},[]).then(({Workbox:s})=>new s("/sw.js",{scope:"/",type:"classic"})).catch(s=>{l==null||l(s)}),!i)return;c=()=>{i==null||i.messageSkipWaiting()};{let s=!1;const F=()=>{s=!0,i==null||i.addEventListener("controlling",g=>{g.isUpdate&&window.location.reload()}),a==null||a()};i.addEventListener("installed",g=>{typeof g.isUpdate>"u"?typeof g.isExternal<"u"&&g.isExternal?F():!s&&(o==null||o()):g.isUpdate||o==null||o()}),i.addEventListener("waiting",F)}i.register({immediate:t}).then(s=>{n?n("/sw.js",s):r==null||r(s)}).catch(s=>{l==null||l(s)})}}return d=y(),p}"serviceWorker"in navigator&&window.addEventListener("load",()=>{se({immediate:!1,onRegistered(e){console.log("Service worker has been registered")},onRegisterError(e){console.error("Service worker registration error",e)}})});const{div:f,header:ce,main:de,aside:ue,h1:fe,h2:K,button:A,input:ge,label:me,span:pe,dialog:ye,nav:be,ul:M,li:B,p:he}=b.tags,u=b.state([]),E=b.state(!1),v=b.state(!0),w=new Map;function ve(e){if(w.has(e.id))return w.get(e.id);const t=URL.createObjectURL(e.file);return w.set(e.id,t),console.log(`Created and tracked blob URL for ${e.id}: ${t}`),t}function we(e){if(w.has(e)){const t=w.get(e);URL.revokeObjectURL(t),w.delete(e),console.log(`Released blob URL for ${e}`)}}function C(){return new Promise((e,t)=>{if(!("indexedDB"in window)){const o=new Error("IndexedDB is not supported in this browser");return console.error(o),t(o)}navigator.storage&&navigator.storage.estimate&&navigator.storage.estimate().then(o=>{const r=o.usage/o.quota*100;console.log(`Storage usage: ${r.toFixed(2)}% of available quota`),r>80&&console.warn("Storage is nearing capacity! Consider clearing some data.")}),console.log("Opening IndexedDB...");const a=indexedDB.open("localfilesDB",1);a.onupgradeneeded=o=>{console.log("Database upgrade needed, creating object store");const r=o.target.result;r.objectStoreNames.contains("mediaFiles")||(r.createObjectStore("mediaFiles",{keyPath:"id"}),console.log("Object store created successfully"))},a.onsuccess=o=>{console.log("IndexedDB opened successfully");const r=o.target.result;r.onerror=n=>{console.error("Database error:",n.target.errorCode)},e(r)},a.onerror=o=>{const r=o.target.error;console.error("IndexedDB error:",r),r.name==="QuotaExceededError"?alert("Storage quota exceeded. Please delete some files before adding more."):alert(`Database error: ${r.message}`),t(r)}})}async function Fe(e,t,a){return new Promise((o,r)=>{if(!e)return console.error("Database not initialized for storeFileBlob"),r(new Error("Database not initialized"));const i=e.transaction("mediaFiles","readwrite").objectStore("mediaFiles").put({id:t,blob:a});i.onsuccess=()=>o(),i.onerror=d=>r(d.target.error)})}async function Se(e,t){return new Promise((a,o)=>{if(!e)return console.error("Database not initialized for retrieveFileBlob"),o(new Error("Database not initialized"));const l=e.transaction("mediaFiles","readonly").objectStore("mediaFiles").get(t);l.onsuccess=()=>a(l.result?l.result.blob:null),l.onerror=i=>o(i.target.error)})}async function _e(e,t){return new Promise((a,o)=>{if(!e)return console.error("Database not initialized for removeFileBlob"),o(new Error("Database not initialized"));const l=e.transaction("mediaFiles","readwrite").objectStore("mediaFiles").delete(t);l.onsuccess=()=>a(),l.onerror=i=>o(i.target.error)})}async function Ee(e){return new Promise((t,a)=>{if(!e)return console.error("Database not initialized for clearAllFileBlobs"),a(new Error("Database not initialized"));const n=e.transaction("mediaFiles","readwrite").objectStore("mediaFiles").clear();n.onsuccess=()=>t(),n.onerror=l=>a(l.target.error)})}const ee="localFilesAppMetadata";function Pe(){try{const e=localStorage.getItem(ee);return e?JSON.parse(e):[]}catch(e){return console.error("Error reading metadata from Local Storage:",e),[]}}function U(e){try{const t=e.map(a=>{const{file:o,...r}=a;return r});localStorage.setItem(ee,JSON.stringify(t))}catch(t){console.error("Error saving metadata to Local Storage:",t),t.name==="QuotaExceededError"&&alert("Local Storage quota exceeded. Cannot save file list. Please clear some browser data.")}}const De=async()=>{try{v.val=!0,console.log("Loading data...");const e=await C(),t=Pe();console.log(`Loaded ${t.length} metadata entries from Local Storage.`);const a=[];for(const o of t)try{const r=await Se(e,o.id);r?a.push({...o,file:r}):console.warn(`Blob not found in IndexedDB for file ID: ${o.id}. Skipping file.`)}catch(r){console.error(`Error loading blob for file ID ${o.id}:`,r)}return u.val=[...a],console.log(`Updated mediaFiles state with ${a.length} files.`),v.val=!1,u.val}catch(e){return console.error("Error in loadData:",e),v.val=!1,[]}};async function Le(e){if(!e||e.length===0){console.error("No files selected");return}document.body.className=document.body.className.replace("is-uploading","");const a=[],o=await C();for(let r=0;r<e.length;r++){const n=e[r];if(console.log(`Processing file ${r+1}/${e.length}: ${n.name}`),n.size>52428800){alert(`File ${n.name} exceeds the 50MB size limit.`);continue}const i={id:`file-${Date.now()}-${r}`,name:n.name,type:n.type,size:n.size,file:n,progress:0,dateAdded:new Date().toISOString()};try{await Fe(o,i.id,i.file),console.log(`Blob for ${i.name} stored in IndexedDB.`),a.push(i)}catch(d){console.error(`Failed to store blob for ${i.name}:`,d),alert(`Could not save file ${i.name} due to a storage error.`);continue}console.log(`File ${n.name} processed successfully`)}if(a.length>0){console.log(`Adding ${a.length} files to the library`);const r=[...u.val,...a];u.val=r,U(r),console.log("File metadata saved to Local Storage."),E.val=!0,alert(`${a.length} files uploaded successfully!`),a.length>0&&setTimeout(()=>{j(a[0])},500)}}function j(e){console.log("Attempting to play file:",e);try{const t=document.getElementById("media-player");if(!t){console.error("Media player element not found"),alert("Media player not found. Please refresh the page.");return}const a=document.getElementById("video-container");a&&(a.style.display="block");const o=document.querySelector(".upload-prompt");o&&(o.style.display="none");let r;if(e.file&&e.file instanceof File)r=ve(e);else if(e.data&&typeof e.data=="string")r=e.data;else{console.error("File has no playable source:",e),alert(`Cannot play ${e.name||"file"}: Invalid source format`);return}console.log(`Setting player source to: ${r}`),t.src=r,t.setAttribute("data-current-file-id",e.id),typeof e.progress=="number"&&(t.currentTime=e.progress),window.innerWidth<768&&(E.val=!1),setTimeout(()=>{const n=t.play();n!==void 0&&n.then(()=>{console.log(`Playing ${e.name||"file"} successfully`);try{localStorage.setItem("lastPlayedFileId",e.id),console.log(`Set lastPlayedFileId to: ${e.id}`)}catch(l){console.warn("Could not save lastPlayedFileId to Local Storage:",l)}}).catch(console.error)},300)}catch(t){console.error("Error in playFile function:",t),alert(`Error playing file: ${t.message}`)}}async function Ie(e){console.log(`Deleting file with ID: ${e}`),we(e);try{const a=await C();await _e(a,e),console.log(`Blob for file ID ${e} removed from IndexedDB.`)}catch(a){console.error(`Failed to remove blob for file ID ${e} from IndexedDB:`,a)}const t=u.val.filter(a=>a.id!==e);u.val=t,U(t),console.log("File metadata updated in Local Storage after deletion.")}function Ae(){document.getElementById("confirm-dialog").showModal()}async function $e(){w.forEach((e,t)=>{URL.revokeObjectURL(e)}),w.clear();try{const e=await C();await Ee(e),console.log("All file blobs cleared from IndexedDB.")}catch(e){console.error("Failed to clear all file blobs from IndexedDB:",e),alert("Could not clear all stored file data. Please try again.")}U([]),console.log("File metadata cleared from Local Storage."),u.val=[],document.getElementById("confirm-dialog").close()}function Be(){document.getElementById("confirm-dialog").close()}function q(e,t){const a=u.val.map(o=>o.id===e?{...o,progress:t}:o);u.val=a,U(a)}function xe(){return ue({class:b.derive(()=>`sidebar ${E.val?"open":""}`),"aria-label":"File sidebar"},K({},"Your Files"),b.derive(()=>v.val?f({class:"loading-message"},"Loading files..."):u.val.length>0?f({},M({},...u.val.map(e=>{console.log("Rendering file in sidebar:",e);const t=e.name||"Unnamed File";return B({class:"file-item","data-id":e.id},pe({onclick:()=>{console.log("Clicked on file:",e),j(e)},class:"file-name"},t),A({class:"delete-btn outline",onclick:a=>{a.stopPropagation(),console.log(`Deleting file: ${e.id}`),Ie(e.id)}},"×"))})),A({class:"delete-all-btn outline",onclick:Ae},"Delete All")):f({class:"empty-message"},"No files added yet")))}function Oe(){return ce({},be({class:"container-fluid"},M(B(A({class:"hamburger outline",onclick:()=>{E.val=!E.val}},"☰")),B(fe({},"localfiles.stream"))),M(B(me({class:"upload-btn",for:"file-upload"},"Upload Files"),ge({type:"file",id:"file-upload",accept:"audio/*,video/*",multiple:!0,style:"display: none",onchange:async e=>{try{e.target.files&&e.target.files.length>0?(await Le(e.target.files),console.log(`Selected ${e.target.files.length} files`)):console.log("No files selected"),e.target.value=""}catch(t){console.error("Error in file input change handler (or during addFiles):",t),alert("Failed to process selected files. Please try again.")}}})))))}function Ce(){return f({class:"media-container"},f({class:"player-wrapper"},f({class:"upload-prompt",style:b.derive(()=>{const e=v.val?!1:u.val.length===0;return console.log(`Upload prompt visibility: ${e?"visible":"hidden"}`),e?"display: flex":"display: none"})},"Upload media files to start playing"),f({class:"loading-indicator",style:b.derive(()=>v.val?"display: flex":"display: none")},"Loading your media files..."),f({id:"video-container",class:"video-container",style:"display: none;"},f({class:"media-element-container"},b.tags.video({id:"media-player",controls:!0,preload:"auto",controlsList:"nodownload",crossorigin:"anonymous",playsinline:!0,ontimeupdate:e=>{const t=e.target.getAttribute("data-current-file-id");t&&q(t,e.target.currentTime)},onplay:e=>{console.log("Media started playing. File ID:",e.target.getAttribute("data-current-file-id"))},onended:e=>{console.log("Media ended. Saving final progress.");const t=e.target.getAttribute("data-current-file-id");t&&e.target.duration&&isFinite(e.target.duration)&&q(t,e.target.duration),e.target.removeAttribute("data-current-file-id")},onerror:e=>{console.error("Media player error:",e.target.error),alert("Error playing media: "+(e.target.error?e.target.error.message:"Unknown error")),e.target.removeAttribute("data-current-file-id")}})))))}function Ue(){return ye({id:"confirm-dialog"},f({class:"dialog-content"},K({},"Confirm Deletion"),he({},"Are you sure you want to delete all files?"),f({class:"dialog-buttons"},A({onclick:Be,class:"secondary"},"Cancel"),A({onclick:$e},"Delete All"))))}function ke(){return f({id:"layout"},Oe(),f({class:"content"},xe(),de({},Ce())),Ue())}(async()=>{try{if(v.val=!0,console.log("Mounting app..."),b.add(document.getElementById("app"),ke()),await new Promise(e=>setTimeout(e,100)),console.log("Loading data..."),await De(),console.log(`App initialized with ${u.val.length} files`),u.val.length>0)try{const e=localStorage.getItem("lastPlayedFileId");if(e){console.log(`Found lastPlayedFileId: ${e}`);const t=u.val.find(a=>a.id===e);t?(console.log("Attempting to autoplay last played file:",t),j(t)):console.log("Last played file ID found, but file not in current media list.")}}catch(e){console.warn("Could not retrieve or play lastPlayedFileId:",e)}u.val.length>0&&(console.log("Files found, showing sidebar"),window.innerWidth<768&&(E.val=!0))}catch(e){console.error("Error initializing app:",e),v.val=!1}})();
