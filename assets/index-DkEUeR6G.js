(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function o(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=o(r);fetch(r.href,a)}})();let w=Object.getPrototypeOf,k,C,p,L,Z={isConnected:1},ge=1e3,T,z={},fe=w(Z),K=w(w),P,ee=(e,t,o,n)=>(e??(setTimeout(o,n),new Set)).add(t),te=(e,t,o)=>{let n=p;p=t;try{return e(o)}catch(r){return console.error(r),o}finally{p=n}},M=e=>e.filter(t=>{var o;return(o=t._dom)==null?void 0:o.isConnected}),oe=e=>T=ee(T,e,()=>{for(let t of T)t._bindings=M(t._bindings),t._listeners=M(t._listeners);T=P},ge),j={get val(){var e;return(e=p==null?void 0:p._getters)==null||e.add(this),this.rawVal},get oldVal(){var e;return(e=p==null?void 0:p._getters)==null||e.add(this),this._oldVal},set val(e){var t;(t=p==null?void 0:p._setters)==null||t.add(this),e!==this.rawVal&&(this.rawVal=e,this._bindings.length+this._listeners.length?(C==null||C.add(this),k=ee(k,this,me)):this._oldVal=e)}},re=e=>({__proto__:j,rawVal:e,_oldVal:e,_bindings:[],_listeners:[]}),x=(e,t)=>{let o={_getters:new Set,_setters:new Set},n={f:e},r=L;L=[];let a=te(e,o,t);a=(a??document).nodeType?a:new Text(a);for(let l of o._getters)o._setters.has(l)||(oe(l),l._bindings.push(n));for(let l of L)l._dom=a;return L=r,n._dom=a},R=(e,t=re(),o)=>{let n={_getters:new Set,_setters:new Set},r={f:e,s:t};r._dom=o??(L==null?void 0:L.push(r))??Z,t.val=te(e,n,t.rawVal);for(let a of n._getters)n._setters.has(a)||(oe(a),a._listeners.push(r));return t},ne=(e,...t)=>{for(let o of t.flat(1/0)){let n=w(o??0),r=n===j?x(()=>o.val):n===K?x(o):o;r!=P&&e.append(r)}return e},ae=(e,t,...o)=>{var s;let[{is:n,...r},...a]=w(o[0]??0)===fe?o:[{},...o],l=e?document.createElementNS(e,t,{is:n}):document.createElement(t,{is:n});for(let[g,c]of Object.entries(r)){let h=A=>A?Object.getOwnPropertyDescriptor(A,g)??h(w(A)):P,y=t+","+g,i=z[y]??(z[y]=((s=h(w(l)))==null?void 0:s.set)??0),_=g.startsWith("on")?(A,ue)=>{let G=g.slice(2);l.removeEventListener(G,ue),l.addEventListener(G,A)}:i?i.bind(l):l.setAttribute.bind(l,g),m=w(c??0);g.startsWith("on")||m===K&&(c=R(c),m=j),m===j?x(()=>(_(c.val,c._oldVal),l)):_(c)}return ne(l,a)},H=e=>({get:(t,o)=>ae.bind(P,e,o)}),le=(e,t)=>t?t!==e&&e.replaceWith(t):e.remove(),me=()=>{let e=0,t=[...k].filter(n=>n.rawVal!==n._oldVal);do{C=new Set;for(let n of new Set(t.flatMap(r=>r._listeners=M(r._listeners))))R(n.f,n.s,n._dom),n._dom=P}while(++e<100&&(t=[...C]).length);let o=[...k].filter(n=>n.rawVal!==n._oldVal);k=P;for(let n of new Set(o.flatMap(r=>r._bindings=M(r._bindings))))le(n._dom,x(n.f,n._dom)),n._dom=P;for(let n of o)n._oldVal=n.rawVal};const u={tags:new Proxy(e=>new Proxy(ae,H(e)),H()),hydrate:(e,t)=>le(e,x(t,e)),add:ne,state:re,derive:R},pe="modulepreload",he=function(e){return"/"+e},J={},ye=function(t,o,n){let r=Promise.resolve();if(o&&o.length>0){let l=function(c){return Promise.all(c.map(h=>Promise.resolve(h).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),g=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));r=l(o.map(c=>{if(c=he(c),c in J)return;J[c]=!0;const h=c.endsWith(".css"),y=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${y}`))return;const i=document.createElement("link");if(i.rel=h?"stylesheet":pe,h||(i.as="script"),i.crossOrigin="",i.href=c,g&&i.setAttribute("nonce",g),document.head.appendChild(i),h)return new Promise((_,m)=>{i.addEventListener("load",_),i.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(l){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=l,window.dispatchEvent(s),!s.defaultPrevented)throw l}return r.then(l=>{for(const s of l||[])s.status==="rejected"&&a(s.reason);return t().catch(a)})};function be(e={}){const{immediate:t=!1,onNeedRefresh:o,onOfflineReady:n,onRegistered:r,onRegisteredSW:a,onRegisterError:l}=e;let s,g,c;const h=async(i=!0)=>{await g,c==null||c()};async function y(){if("serviceWorker"in navigator){if(s=await ye(async()=>{const{Workbox:i}=await import("./workbox-window.prod.es5-CwtvwXb3.js");return{Workbox:i}},[]).then(({Workbox:i})=>new i("/sw.js",{scope:"/",type:"classic"})).catch(i=>{l==null||l(i)}),!s)return;c=()=>{s==null||s.messageSkipWaiting()};{let i=!1;const _=()=>{i=!0,s==null||s.addEventListener("controlling",m=>{m.isUpdate&&window.location.reload()}),o==null||o()};s.addEventListener("installed",m=>{typeof m.isUpdate>"u"?typeof m.isExternal<"u"&&m.isExternal?_():!i&&(n==null||n()):m.isUpdate||n==null||n()}),s.addEventListener("waiting",_)}s.register({immediate:t}).then(i=>{a?a("/sw.js",i):r==null||r(i)}).catch(i=>{l==null||l(i)})}}return g=y(),h}const E=u.state(localStorage.getItem("debugMode")==="true"||window.location.hash==="#debug"),$=u.state(!1),D=u.state([]),we=200,N={log:console.log,error:console.error,warn:console.warn,info:console.info};function O(e,t){const o=new Date().toLocaleTimeString(),n=t.map(a=>{if(typeof a=="object")try{return JSON.stringify(a,null,2)}catch{return String(a)}return String(a)}).join(" "),r=[...D.val,{timestamp:o,level:e,message:n}];r.length>we&&r.shift(),D.val=r}console.log=function(...e){N.log.apply(console,e),O("log",e)};console.error=function(...e){N.error.apply(console,e),O("error",e)};console.warn=function(...e){N.warn.apply(console,e),O("warn",e)};console.info=function(...e){N.info.apply(console,e),O("info",e)};var Y;(Y=navigator.serviceWorker)==null||Y.addEventListener("message",e=>{e.data&&e.data.type==="SW_LOG"&&O(e.data.level,[e.data.message])});function b(e){if(console.error(e),E.val)throw e}function q(e,t={}){console.error("Displaying error on screen:",e,t);const o=document.createElement("div");o.id="error-display",o.style.cssText=`
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: white;
    color: black;
    padding: 20px;
    overflow: auto;
    z-index: 99999;
    font-family: monospace;
  `;const n=document.createElement("pre");n.style.cssText=`
    white-space: pre-wrap;
    word-wrap: break-word;
    margin: 0;
  `;let r=`APPLICATION ERROR

`;e instanceof Error?(r+=`Name: ${e.name}
`,r+=`Message: ${e.message}

`,e.stack&&(r+=`Stack Trace:
${e.stack}

`)):r+=`Error: ${String(e)}

`,t.context&&(r+=`Context: ${t.context}
`),t.filename&&(r+=`File: ${t.filename}
`),t.lineno&&(r+=`Line: ${t.lineno}
`),t.colno&&(r+=`Column: ${t.colno}
`),t.reason&&(r+=`
Rejection Reason:
${t.reason}
`,t.promise&&(r+=`Promise: ${t.promise}
`)),n.textContent=r,o.appendChild(n),document.body.innerHTML="",document.body.appendChild(o)}window.onerror=function(e,t,o,n,r){return q(r||new Error(e),{filename:t,lineno:o,colno:n,message:e}),!0};window.addEventListener("unhandledrejection",function(e){q(e.reason instanceof Error?e.reason:new Error(String(e.reason)),{reason:e.reason,promise:e.promise}),e.preventDefault()});"serviceWorker"in navigator&&window.addEventListener("load",()=>{be({immediate:!1,onRegistered(e){console.log("Service worker has been registered")},onRegisterError(e){console.error("Service worker registration error",e)}})});const{div:d,header:ve,main:Se,aside:Fe,h1:_e,h2:se,button:v,input:Ee,label:Le,span:U,dialog:Pe,nav:Ye,ul:$e,li:De,p:Ae,a:ie,img:ke}=u.tags,f=u.state([]),I=u.state(!1),S=u.state(!0),F=new Map;function Ce(e){if(F.has(e.id))return F.get(e.id);const t=URL.createObjectURL(e.file);return F.set(e.id,t),console.log(`Created and tracked blob URL for ${e.id}: ${t}`),t}function xe(e){if(F.has(e)){const t=F.get(e);URL.revokeObjectURL(t),F.delete(e),console.log(`Released blob URL for ${e}`)}}function B(){return new Promise((e,t)=>{var n;if(!("indexedDB"in window)){const r=new Error("IndexedDB is not supported in this browser");return console.error(r),t(r)}(n=navigator.storage)!=null&&n.estimate&&navigator.storage.estimate().then(r=>{const a=r.usage/r.quota*100;console.log(`Storage usage: ${a.toFixed(2)}% of available quota`),a>80&&console.warn("Storage is nearing capacity! Consider clearing some data.")}),console.log("Opening IndexedDB...");const o=indexedDB.open("localfilesDB",2);o.onupgradeneeded=r=>{console.log("Database upgrade needed, creating object stores");const a=r.target.result;a.objectStoreNames.contains("mediaFiles")||(a.createObjectStore("mediaFiles",{keyPath:"id"}),console.log("mediaFiles object store created successfully")),a.objectStoreNames.contains("sharedFiles")||(a.createObjectStore("sharedFiles",{keyPath:"id"}),console.log("sharedFiles object store created successfully"))},o.onsuccess=r=>{console.log("IndexedDB opened successfully");const a=r.target.result;a.onerror=l=>{console.error("Database error:",l.target.errorCode)},e(a)},o.onerror=r=>{const a=r.target.error;console.error("IndexedDB error:",a),a.name==="QuotaExceededError"?alert("Storage quota exceeded. Please delete some files before adding more."):alert(`Database error: ${a.message}`),t(a)}})}async function Ie(e,t,o){return new Promise((n,r)=>{if(!e)return console.error("Database not initialized for storeFileBlob"),r(new Error("Database not initialized"));const s=e.transaction("mediaFiles","readwrite").objectStore("mediaFiles").put({id:t,blob:o});s.onsuccess=()=>n(),s.onerror=g=>r(g.target.error)})}async function Oe(e,t){return new Promise((o,n)=>{if(!e)return console.error("Database not initialized for retrieveFileBlob"),n(new Error("Database not initialized"));const l=e.transaction("mediaFiles","readonly").objectStore("mediaFiles").get(t);l.onsuccess=()=>o(l.result?l.result.blob:null),l.onerror=s=>n(s.target.error)})}async function Be(e,t){return new Promise((o,n)=>{if(!e)return console.error("Database not initialized for removeFileBlob"),n(new Error("Database not initialized"));const l=e.transaction("mediaFiles","readwrite").objectStore("mediaFiles").delete(t);l.onsuccess=()=>o(),l.onerror=s=>n(s.target.error)})}async function Te(e){return new Promise((t,o)=>{if(!e)return console.error("Database not initialized for clearAllFileBlobs"),o(new Error("Database not initialized"));const a=e.transaction("mediaFiles","readwrite").objectStore("mediaFiles").clear();a.onsuccess=()=>t(),a.onerror=l=>o(l.target.error)})}async function Ue(e){return new Promise((t,o)=>{if(!e)return console.error("Database not initialized for retrieveSharedFiles"),o(new Error("Database not initialized"));const a=e.transaction("sharedFiles","readonly").objectStore("sharedFiles").getAll();a.onsuccess=()=>t(a.result||[]),a.onerror=l=>o(l.target.error)})}async function Me(e){return new Promise((t,o)=>{if(!e)return console.error("Database not initialized for clearSharedFiles"),o(new Error("Database not initialized"));const a=e.transaction("sharedFiles","readwrite").objectStore("sharedFiles").clear();a.onsuccess=()=>t(),a.onerror=l=>o(l.target.error)})}async function X(){try{const e=await B(),t=await Ue(e);if(t.length>0){console.log(`Found ${t.length} shared files to process`);const o=t.map(n=>n.file);return await de(o),await Me(e),alert(`${t.length} shared file(s) added to your library!`),!0}return!1}catch(e){return b(e),!1}}const ce="localFilesAppMetadata";function je(){try{const e=localStorage.getItem(ce);return e?JSON.parse(e):[]}catch(e){return b(e),[]}}function V(e){try{const t=e.map(o=>{const{file:n,...r}=o;return r});localStorage.setItem(ce,JSON.stringify(t))}catch(t){b(t),t.name==="QuotaExceededError"&&alert("Local Storage quota exceeded. Cannot save file list. Please clear some browser data.")}}const Ne=async()=>{try{S.val=!0,console.log("Loading data...");const e=await B(),t=je();console.log(`Loaded ${t.length} metadata entries from Local Storage.`);const o=[];for(const n of t)try{const r=await Oe(e,n.id);r?o.push({...n,file:r}):console.warn(`Blob not found in IndexedDB for file ID: ${n.id}. Skipping file.`)}catch(r){b(r)}return f.val=[...o],console.log(`Updated mediaFiles state with ${o.length} files.`),S.val=!1,f.val}catch(e){return b(e),S.val=!1,[]}};async function de(e){if(!e||e.length===0){console.error("No files selected");return}document.body.className=document.body.className.replace("is-uploading","");const o=[],n=await B();for(let r=0;r<e.length;r++){const a=e[r],l=a.name||`shared-file-${Date.now()}-${r}.${a.type.split("/")[1]||"bin"}`;if(console.log(`Processing file ${r+1}/${e.length}: ${l}`),a.size>1048576e3){alert(`File ${l} exceeds the 1000MB size limit.`);continue}const g={id:`file-${Date.now()}-${r}`,name:l,type:a.type,size:a.size,file:a,progress:0,dateAdded:new Date().toISOString()};try{await Ie(n,g.id,g.file),console.log(`Blob for ${g.name} stored in IndexedDB.`),o.push(g)}catch(c){b(c),alert(`Could not save file ${g.name} due to a storage error.`);continue}console.log(`File ${l} processed successfully`)}if(o.length>0){console.log(`Adding ${o.length} files to the library`);const r=[...f.val,...o];f.val=r,V(r),console.log("File metadata saved to Local Storage."),I.val=!0,alert(`${o.length} files uploaded successfully!`),o.length>0&&setTimeout(()=>{W(o[0])},500)}}function W(e){console.log("Attempting to play file:",e);try{const t=document.getElementById("media-player");if(!t){console.error("Media player element not found"),alert("Media player not found. Please refresh the page.");return}const o=document.getElementById("video-container");o&&(o.style.display="block");const n=document.querySelector(".upload-prompt");n&&(n.style.display="none");let r;if(e.file&&e.file instanceof File)r=Ce(e);else if(e.data&&typeof e.data=="string")r=e.data;else{console.error("File has no playable source:",e),alert(`Cannot play ${e.name||"file"}: Invalid source format`);return}console.log(`Setting player source to: ${r}`),t.src=r,t.setAttribute("data-current-file-id",e.id),typeof e.progress=="number"&&(t.currentTime=e.progress),window.innerWidth<768&&(I.val=!1),setTimeout(()=>{const a=t.play();a!==void 0&&a.then(()=>{console.log(`Playing ${e.name||"file"} successfully`);try{localStorage.setItem("lastPlayedFileId",e.id),console.log(`Set lastPlayedFileId to: ${e.id}`)}catch(l){console.warn("Could not save lastPlayedFileId to Local Storage:",l)}}).catch(console.error)},300)}catch(t){b(t),alert(`Error playing file: ${t.message}`)}}async function Ve(e){console.log(`Deleting file with ID: ${e}`),xe(e);try{const o=await B();await Be(o,e),console.log(`Blob for file ID ${e} removed from IndexedDB.`)}catch(o){b(o)}const t=f.val.filter(o=>o.id!==e);f.val=t,V(t),console.log("File metadata updated in Local Storage after deletion.")}function ze(){document.getElementById("confirm-dialog").showModal()}async function Re(){F.forEach((e,t)=>{URL.revokeObjectURL(e)}),F.clear();try{const e=await B();await Te(e),console.log("All file blobs cleared from IndexedDB.")}catch(e){b(e),alert("Could not clear all stored file data. Please try again.")}V([]),console.log("File metadata cleared from Local Storage."),f.val=[],document.getElementById("confirm-dialog").close()}function qe(){document.getElementById("confirm-dialog").close()}function Q(e,t){const o=f.val.map(n=>n.id===e?{...n,progress:t}:n);f.val=o,V(o)}function We(){return Fe({class:u.derive(()=>`sidebar ${I.val?"open":""}`),"aria-label":"File sidebar"},se({},"Your Files"),u.derive(()=>S.val?d({class:"loading-message"},"Loading files..."):f.val.length>0?d({},$e({},...f.val.map(e=>{console.log("Rendering file in sidebar:",e);const t=e.name||"Unnamed File";return De({class:"file-item","data-id":e.id},U({onclick:()=>{console.log("Clicked on file:",e),W(e)},class:"file-name"},t),v({class:"delete-btn outline",onclick:o=>{o.stopPropagation(),console.log(`Deleting file: ${e.id}`),Ve(e.id)}},"×"))})),v({class:"delete-all-btn outline",onclick:ze},"Delete All")):d({class:"empty-message"},"No files added yet")),d({class:"sidebar-footer"},v({class:u.derive(()=>`debug-toggle ${E.val?"active":""}`),onclick:()=>{E.val=!E.val,localStorage.setItem("debugMode",E.val)}},u.derive(()=>E.val?"Debug: ON":"Debug: OFF")),ie({href:"https://github.com/netanel-haber/localfiles.stream/commit/3e705199f92ef26069bbcca9dc325280bf03b9f3",target:"_blank",rel:"noopener noreferrer",class:"commit-link"},`${"3e705199f92ef26069bbcca9dc325280bf03b9f3".substring(0,7)}`)))}function Ge(){return ve({},d(v({class:"hamburger outline",onclick:()=>{I.val=!I.val}},"☰"),_e({},"localfiles.stream"),d({class:"github-link"},ie({href:"https://github.com/netanel-haber/localfiles.stream",target:"_blank"},ke({src:"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",alt:"GitHub"})))),d(Le({class:"upload-btn",for:"file-upload"},"Upload Files"),Ee({type:"file",id:"file-upload",accept:"audio/*,video/*",multiple:!0,style:"display: none",onchange:async e=>{try{e.target.files&&e.target.files.length>0?(await de(e.target.files),console.log(`Selected ${e.target.files.length} files`)):console.log("No files selected"),e.target.value=""}catch(t){b(t),alert("Failed to process selected files. Please try again.")}}})))}function He(){return d({class:"media-container"},d({class:"player-wrapper"},d({class:"upload-prompt",style:u.derive(()=>{const e=S.val?!1:f.val.length===0;return console.log(`Upload prompt visibility: ${e?"visible":"hidden"}`),e?"display: flex":"display: none"})},"Upload media files to start playing"),d({class:"loading-indicator",style:u.derive(()=>S.val?"display: flex":"display: none")},"Loading your media files..."),d({id:"video-container",class:"video-container",style:"display: none;"},d({class:"media-element-container"},u.tags.video({id:"media-player",controls:!0,preload:"auto",controlsList:"nodownload",crossorigin:"anonymous",playsinline:!0,ontimeupdate:e=>{const t=e.target.getAttribute("data-current-file-id");t&&Q(t,e.target.currentTime)},onplay:e=>{console.log("Media started playing. File ID:",e.target.getAttribute("data-current-file-id"))},onended:e=>{console.log("Media ended. Saving final progress.");const t=e.target.getAttribute("data-current-file-id");t&&e.target.duration&&Number.isFinite(e.target.duration)&&Q(t,e.target.duration),e.target.removeAttribute("data-current-file-id")},onerror:e=>{console.error("Media player error:",e.target.error),alert(`Error playing media: ${e.target.error?e.target.error.message:"Unknown error"}`),e.target.removeAttribute("data-current-file-id")}})))))}function Je(){return Pe({id:"confirm-dialog"},d({class:"dialog-content"},se({},"Confirm Deletion"),Ae({},"Are you sure you want to delete all files?"),d({class:"dialog-buttons"},v({onclick:qe,class:"secondary"},"Cancel"),v({onclick:Re},"Delete All"))))}function Xe(){return u.derive(()=>E.val?d({class:u.derive(()=>`console-viewer ${$.val?"open":"closed"}`)},d({class:"console-header"},U({},`Console (${D.val.length})`),d({class:"console-controls"},v({class:"console-btn",onclick:()=>{D.val=[]}},"Clear"),v({class:"console-btn",onclick:()=>{$.val=!$.val}},u.derive(()=>$.val?"▼":"▲")))),u.derive(()=>$.val?d({class:"console-logs",id:"console-logs-container"},...D.val.map(e=>d({class:`console-entry console-${e.level}`},U({class:"console-timestamp"},e.timestamp),U({class:"console-level"},e.level.toUpperCase()),u.tags.pre({class:"console-message"},e.message)))):null)):null)}u.derive(()=>{$.val&&D.val.length>0&&setTimeout(()=>{const e=document.getElementById("console-logs-container");e&&(e.scrollTop=e.scrollHeight)},10)});function Qe(){return d({id:"layout"},Ge(),d({class:"content"},We(),Se({},He())),Je(),Xe())}(async()=>{try{S.val=!0,console.log("Mounting app..."),u.add(document.getElementById("app"),Qe()),await new Promise(t=>setTimeout(t,100)),console.log("Loading data..."),await Ne();const e=new URLSearchParams(window.location.search);if(e.get("shared")==="true")console.log("App opened with shared files, processing..."),await X(),window.history.replaceState({},document.title,window.location.pathname);else if(e.get("error")==="share_failed"){console.error("Share operation failed");const t=e.get("error_msg"),o=e.get("error_name"),n=new Error(t||"Failed to share files");n.name=o||"ShareError",q(n,{message:"Service worker share handler failed",context:"Android share operation"}),window.history.replaceState({},document.title,window.location.pathname)}else await X();if(console.log(`App initialized with ${f.val.length} files`),f.val.length>0)try{const t=localStorage.getItem("lastPlayedFileId");if(t){console.log(`Found lastPlayedFileId: ${t}`);const o=f.val.find(n=>n.id===t);o?(console.log("Attempting to autoplay last played file:",o),W(o)):console.log("Last played file ID found, but file not in current media list.")}}catch(t){console.warn("Could not retrieve or play lastPlayedFileId:",t)}f.val.length>0&&console.log("Files found, showing sidebar")}catch(e){b(e),S.val=!1}})();
