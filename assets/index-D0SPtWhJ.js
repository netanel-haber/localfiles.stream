(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function o(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(a){if(a.ep)return;a.ep=!0;const n=o(a);fetch(a.href,n)}})();let b=Object.getPrototypeOf,D,L,m,S,R={isConnected:1},ae=1e3,x,C={},ne=b(R),G=b(b),_,H=(e,t,o,r)=>(e??(setTimeout(o,r),new Set)).add(t),J=(e,t,o)=>{let r=m;m=t;try{return e(o)}catch(a){return console.error(a),o}finally{m=r}},k=e=>e.filter(t=>{var o;return(o=t._dom)==null?void 0:o.isConnected}),Q=e=>x=H(x,e,()=>{for(let t of x)t._bindings=k(t._bindings),t._listeners=k(t._listeners);x=_},ae),O={get val(){var e;return(e=m==null?void 0:m._getters)==null||e.add(this),this.rawVal},get oldVal(){var e;return(e=m==null?void 0:m._getters)==null||e.add(this),this._oldVal},set val(e){var t;(t=m==null?void 0:m._setters)==null||t.add(this),e!==this.rawVal&&(this.rawVal=e,this._bindings.length+this._listeners.length?(L==null||L.add(this),D=H(D,this,le)):this._oldVal=e)}},X=e=>({__proto__:O,rawVal:e,_oldVal:e,_bindings:[],_listeners:[]}),I=(e,t)=>{let o={_getters:new Set,_setters:new Set},r={f:e},a=S;S=[];let n=J(e,o,t);n=(n??document).nodeType?n:new Text(n);for(let l of o._getters)o._setters.has(l)||(Q(l),l._bindings.push(r));for(let l of S)l._dom=n;return S=a,r._dom=n},T=(e,t=X(),o)=>{let r={_getters:new Set,_setters:new Set},a={f:e,s:t};a._dom=o??(S==null?void 0:S.push(a))??R,t.val=J(e,r,t.rawVal);for(let n of r._getters)r._setters.has(n)||(Q(n),n._listeners.push(a));return t},Y=(e,...t)=>{for(let o of t.flat(1/0)){let r=b(o??0),a=r===O?I(()=>o.val):r===G?I(o):o;a!=_&&e.append(a)}return e},Z=(e,t,...o)=>{var s;let[{is:r,...a},...n]=b(o[0]??0)===ne?o:[{},...o],l=e?document.createElementNS(e,t,{is:r}):document.createElement(t,{is:r});for(let[d,c]of Object.entries(a)){let p=P=>P?Object.getOwnPropertyDescriptor(P,d)??p(b(P)):_,h=t+","+d,i=C[h]??(C[h]=((s=p(b(l)))==null?void 0:s.set)??0),F=d.startsWith("on")?(P,re)=>{let M=d.slice(2);l.removeEventListener(M,re),l.addEventListener(M,P)}:i?i.bind(l):l.setAttribute.bind(l,d),g=b(c??0);d.startsWith("on")||g===G&&(c=T(c),g=O),g===O?I(()=>(F(c.val,c._oldVal),l)):F(c)}return Y(l,n)},V=e=>({get:(t,o)=>Z.bind(_,e,o)}),K=(e,t)=>t?t!==e&&e.replaceWith(t):e.remove(),le=()=>{let e=0,t=[...D].filter(r=>r.rawVal!==r._oldVal);do{L=new Set;for(let r of new Set(t.flatMap(a=>a._listeners=k(a._listeners))))T(r.f,r.s,r._dom),r._dom=_}while(++e<100&&(t=[...L]).length);let o=[...D].filter(r=>r.rawVal!==r._oldVal);D=_;for(let r of new Set(o.flatMap(a=>a._bindings=k(a._bindings))))K(r._dom,I(r.f,r._dom)),r._dom=_;for(let r of o)r._oldVal=r.rawVal};const y={tags:new Proxy(e=>new Proxy(Z,V(e)),V()),hydrate:(e,t)=>K(e,I(t,e)),add:Y,state:X,derive:T},se="modulepreload",ie=function(e){return"/"+e},q={},ce=function(t,o,r){let a=Promise.resolve();if(o&&o.length>0){let l=function(c){return Promise.all(c.map(p=>Promise.resolve(p).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),d=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));a=l(o.map(c=>{if(c=ie(c),c in q)return;q[c]=!0;const p=c.endsWith(".css"),h=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${h}`))return;const i=document.createElement("link");if(i.rel=p?"stylesheet":se,p||(i.as="script"),i.crossOrigin="",i.href=c,d&&i.setAttribute("nonce",d),document.head.appendChild(i),p)return new Promise((F,g)=>{i.addEventListener("load",F),i.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(l){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=l,window.dispatchEvent(s),!s.defaultPrevented)throw l}return a.then(l=>{for(const s of l||[])s.status==="rejected"&&n(s.reason);return t().catch(n)})};function de(e={}){const{immediate:t=!1,onNeedRefresh:o,onOfflineReady:r,onRegistered:a,onRegisteredSW:n,onRegisterError:l}=e;let s,d,c;const p=async(i=!0)=>{await d,c==null||c()};async function h(){if("serviceWorker"in navigator){if(s=await ce(async()=>{const{Workbox:i}=await import("./workbox-window.prod.es5-B9K5rw8f.js");return{Workbox:i}},[]).then(({Workbox:i})=>new i("/sw.js",{scope:"/",type:"classic"})).catch(i=>{l==null||l(i)}),!s)return;c=()=>{s==null||s.messageSkipWaiting()};{let i=!1;const F=()=>{i=!0,s==null||s.addEventListener("controlling",g=>{g.isUpdate&&window.location.reload()}),o==null||o()};s.addEventListener("installed",g=>{typeof g.isUpdate>"u"?typeof g.isExternal<"u"&&g.isExternal?F():!i&&(r==null||r()):g.isUpdate||r==null||r()}),s.addEventListener("waiting",F)}s.register({immediate:t}).then(i=>{n?n("/sw.js",i):a==null||a(i)}).catch(i=>{l==null||l(i)})}}return d=h(),p}"serviceWorker"in navigator&&window.addEventListener("load",()=>{de({immediate:!1,onRegistered(e){console.log("Service worker has been registered")},onRegisterError(e){console.error("Service worker registration error",e)}})});const{div:f,header:ue,main:fe,aside:ge,h1:me,h2:ee,button:A,input:pe,label:he,span:ye,dialog:be,nav:we,ul:j,li:E,p:ve,a:Fe,img:Se}=y.tags,u=y.state([]),$=y.state(!1),w=y.state(!0),v=new Map;function _e(e){if(v.has(e.id))return v.get(e.id);const t=URL.createObjectURL(e.file);return v.set(e.id,t),console.log(`Created and tracked blob URL for ${e.id}: ${t}`),t}function Pe(e){if(v.has(e)){const t=v.get(e);URL.revokeObjectURL(t),v.delete(e),console.log(`Released blob URL for ${e}`)}}function B(){return new Promise((e,t)=>{var r;if(!("indexedDB"in window)){const a=new Error("IndexedDB is not supported in this browser");return console.error(a),t(a)}(r=navigator.storage)!=null&&r.estimate&&navigator.storage.estimate().then(a=>{const n=a.usage/a.quota*100;console.log(`Storage usage: ${n.toFixed(2)}% of available quota`),n>80&&console.warn("Storage is nearing capacity! Consider clearing some data.")}),console.log("Opening IndexedDB...");const o=indexedDB.open("localfilesDB",2);o.onupgradeneeded=a=>{console.log("Database upgrade needed, creating object stores");const n=a.target.result;n.objectStoreNames.contains("mediaFiles")||(n.createObjectStore("mediaFiles",{keyPath:"id"}),console.log("mediaFiles object store created successfully")),n.objectStoreNames.contains("sharedFiles")||(n.createObjectStore("sharedFiles",{keyPath:"id"}),console.log("sharedFiles object store created successfully"))},o.onsuccess=a=>{console.log("IndexedDB opened successfully");const n=a.target.result;n.onerror=l=>{console.error("Database error:",l.target.errorCode)},e(n)},o.onerror=a=>{const n=a.target.error;console.error("IndexedDB error:",n),n.name==="QuotaExceededError"?alert("Storage quota exceeded. Please delete some files before adding more."):alert(`Database error: ${n.message}`),t(n)}})}async function Ee(e,t,o){return new Promise((r,a)=>{if(!e)return console.error("Database not initialized for storeFileBlob"),a(new Error("Database not initialized"));const s=e.transaction("mediaFiles","readwrite").objectStore("mediaFiles").put({id:t,blob:o});s.onsuccess=()=>r(),s.onerror=d=>a(d.target.error)})}async function De(e,t){return new Promise((o,r)=>{if(!e)return console.error("Database not initialized for retrieveFileBlob"),r(new Error("Database not initialized"));const l=e.transaction("mediaFiles","readonly").objectStore("mediaFiles").get(t);l.onsuccess=()=>o(l.result?l.result.blob:null),l.onerror=s=>r(s.target.error)})}async function Le(e,t){return new Promise((o,r)=>{if(!e)return console.error("Database not initialized for removeFileBlob"),r(new Error("Database not initialized"));const l=e.transaction("mediaFiles","readwrite").objectStore("mediaFiles").delete(t);l.onsuccess=()=>o(),l.onerror=s=>r(s.target.error)})}async function Ie(e){return new Promise((t,o)=>{if(!e)return console.error("Database not initialized for clearAllFileBlobs"),o(new Error("Database not initialized"));const n=e.transaction("mediaFiles","readwrite").objectStore("mediaFiles").clear();n.onsuccess=()=>t(),n.onerror=l=>o(l.target.error)})}async function Ae(e){return new Promise((t,o)=>{if(!e)return console.error("Database not initialized for retrieveSharedFiles"),o(new Error("Database not initialized"));const n=e.transaction("sharedFiles","readonly").objectStore("sharedFiles").getAll();n.onsuccess=()=>t(n.result||[]),n.onerror=l=>o(l.target.error)})}async function $e(e){return new Promise((t,o)=>{if(!e)return console.error("Database not initialized for clearSharedFiles"),o(new Error("Database not initialized"));const n=e.transaction("sharedFiles","readwrite").objectStore("sharedFiles").clear();n.onsuccess=()=>t(),n.onerror=l=>o(l.target.error)})}async function N(){try{const e=await B(),t=await Ae(e);if(t.length>0){console.log(`Found ${t.length} shared files to process`);const o=t.map(r=>r.file);return await oe(o),await $e(e),alert(`${t.length} shared file(s) added to your library!`),!0}return!1}catch(e){return console.error("Error processing shared files:",e),!1}}const te="localFilesAppMetadata";function Be(){try{const e=localStorage.getItem(te);return e?JSON.parse(e):[]}catch(e){return console.error("Error reading metadata from Local Storage:",e),[]}}function U(e){try{const t=e.map(o=>{const{file:r,...a}=o;return a});localStorage.setItem(te,JSON.stringify(t))}catch(t){console.error("Error saving metadata to Local Storage:",t),t.name==="QuotaExceededError"&&alert("Local Storage quota exceeded. Cannot save file list. Please clear some browser data.")}}const xe=async()=>{try{w.val=!0,console.log("Loading data...");const e=await B(),t=Be();console.log(`Loaded ${t.length} metadata entries from Local Storage.`);const o=[];for(const r of t)try{const a=await De(e,r.id);a?o.push({...r,file:a}):console.warn(`Blob not found in IndexedDB for file ID: ${r.id}. Skipping file.`)}catch(a){console.error(`Error loading blob for file ID ${r.id}:`,a)}return u.val=[...o],console.log(`Updated mediaFiles state with ${o.length} files.`),w.val=!1,u.val}catch(e){return console.error("Error in loadData:",e),w.val=!1,[]}};async function oe(e){if(!e||e.length===0){console.error("No files selected");return}document.body.className=document.body.className.replace("is-uploading","");const o=[],r=await B();for(let a=0;a<e.length;a++){const n=e[a];if(console.log(`Processing file ${a+1}/${e.length}: ${n.name}`),n.size>1048576e3){alert(`File ${n.name} exceeds the 1000MB size limit.`);continue}const s={id:`file-${Date.now()}-${a}`,name:n.name,type:n.type,size:n.size,file:n,progress:0,dateAdded:new Date().toISOString()};try{await Ee(r,s.id,s.file),console.log(`Blob for ${s.name} stored in IndexedDB.`),o.push(s)}catch(d){console.error(`Failed to store blob for ${s.name}:`,d),alert(`Could not save file ${s.name} due to a storage error.`);continue}console.log(`File ${n.name} processed successfully`)}if(o.length>0){console.log(`Adding ${o.length} files to the library`);const a=[...u.val,...o];u.val=a,U(a),console.log("File metadata saved to Local Storage."),$.val=!0,alert(`${o.length} files uploaded successfully!`),o.length>0&&setTimeout(()=>{z(o[0])},500)}}function z(e){console.log("Attempting to play file:",e);try{const t=document.getElementById("media-player");if(!t){console.error("Media player element not found"),alert("Media player not found. Please refresh the page.");return}const o=document.getElementById("video-container");o&&(o.style.display="block");const r=document.querySelector(".upload-prompt");r&&(r.style.display="none");let a;if(e.file&&e.file instanceof File)a=_e(e);else if(e.data&&typeof e.data=="string")a=e.data;else{console.error("File has no playable source:",e),alert(`Cannot play ${e.name||"file"}: Invalid source format`);return}console.log(`Setting player source to: ${a}`),t.src=a,t.setAttribute("data-current-file-id",e.id),typeof e.progress=="number"&&(t.currentTime=e.progress),window.innerWidth<768&&($.val=!1),setTimeout(()=>{const n=t.play();n!==void 0&&n.then(()=>{console.log(`Playing ${e.name||"file"} successfully`);try{localStorage.setItem("lastPlayedFileId",e.id),console.log(`Set lastPlayedFileId to: ${e.id}`)}catch(l){console.warn("Could not save lastPlayedFileId to Local Storage:",l)}}).catch(console.error)},300)}catch(t){console.error("Error in playFile function:",t),alert(`Error playing file: ${t.message}`)}}async function ke(e){console.log(`Deleting file with ID: ${e}`),Pe(e);try{const o=await B();await Le(o,e),console.log(`Blob for file ID ${e} removed from IndexedDB.`)}catch(o){console.error(`Failed to remove blob for file ID ${e} from IndexedDB:`,o)}const t=u.val.filter(o=>o.id!==e);u.val=t,U(t),console.log("File metadata updated in Local Storage after deletion.")}function Oe(){document.getElementById("confirm-dialog").showModal()}async function Ue(){v.forEach((e,t)=>{URL.revokeObjectURL(e)}),v.clear();try{const e=await B();await Ie(e),console.log("All file blobs cleared from IndexedDB.")}catch(e){console.error("Failed to clear all file blobs from IndexedDB:",e),alert("Could not clear all stored file data. Please try again.")}U([]),console.log("File metadata cleared from Local Storage."),u.val=[],document.getElementById("confirm-dialog").close()}function Ce(){document.getElementById("confirm-dialog").close()}function W(e,t){const o=u.val.map(r=>r.id===e?{...r,progress:t}:r);u.val=o,U(o)}function je(){return ge({class:y.derive(()=>`sidebar ${$.val?"open":""}`),"aria-label":"File sidebar"},ee({},"Your Files"),y.derive(()=>w.val?f({class:"loading-message"},"Loading files..."):u.val.length>0?f({},j({},...u.val.map(e=>{console.log("Rendering file in sidebar:",e);const t=e.name||"Unnamed File";return E({class:"file-item","data-id":e.id},ye({onclick:()=>{console.log("Clicked on file:",e),z(e)},class:"file-name"},t),A({class:"delete-btn outline",onclick:o=>{o.stopPropagation(),console.log(`Deleting file: ${e.id}`),ke(e.id)}},"×"))})),A({class:"delete-all-btn outline",onclick:Oe},"Delete All")):f({class:"empty-message"},"No files added yet")))}function Te(){return ue({},we({class:"container-fluid"},j(E(A({class:"hamburger outline",onclick:()=>{$.val=!$.val}},"☰")),E(me({},"localfiles.stream")),E(Fe({href:"https://github.com/netanel-haber/localfiles.stream",target:"_blank"},Se({src:"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",alt:"GitHub",style:"height: 20px;"})))),j(E(he({class:"upload-btn",for:"file-upload"},"Upload Files"),pe({type:"file",id:"file-upload",accept:"audio/*,video/*",multiple:!0,style:"display: none",onchange:async e=>{try{e.target.files&&e.target.files.length>0?(await oe(e.target.files),console.log(`Selected ${e.target.files.length} files`)):console.log("No files selected"),e.target.value=""}catch(t){console.error("Error in file input change handler (or during addFiles):",t),alert("Failed to process selected files. Please try again.")}}})))))}function ze(){return f({class:"media-container"},f({class:"player-wrapper"},f({class:"upload-prompt",style:y.derive(()=>{const e=w.val?!1:u.val.length===0;return console.log(`Upload prompt visibility: ${e?"visible":"hidden"}`),e?"display: flex":"display: none"})},"Upload media files to start playing"),f({class:"loading-indicator",style:y.derive(()=>w.val?"display: flex":"display: none")},"Loading your media files..."),f({id:"video-container",class:"video-container",style:"display: none;"},f({class:"media-element-container"},y.tags.video({id:"media-player",controls:!0,preload:"auto",controlsList:"nodownload",crossorigin:"anonymous",playsinline:!0,ontimeupdate:e=>{const t=e.target.getAttribute("data-current-file-id");t&&W(t,e.target.currentTime)},onplay:e=>{console.log("Media started playing. File ID:",e.target.getAttribute("data-current-file-id"))},onended:e=>{console.log("Media ended. Saving final progress.");const t=e.target.getAttribute("data-current-file-id");t&&e.target.duration&&Number.isFinite(e.target.duration)&&W(t,e.target.duration),e.target.removeAttribute("data-current-file-id")},onerror:e=>{console.error("Media player error:",e.target.error),alert(`Error playing media: ${e.target.error?e.target.error.message:"Unknown error"}`),e.target.removeAttribute("data-current-file-id")}})))))}function Me(){return be({id:"confirm-dialog"},f({class:"dialog-content"},ee({},"Confirm Deletion"),ve({},"Are you sure you want to delete all files?"),f({class:"dialog-buttons"},A({onclick:Ce,class:"secondary"},"Cancel"),A({onclick:Ue},"Delete All"))))}function Ve(){return f({id:"layout"},Te(),f({class:"content"},je(),fe({},ze())),Me())}(async()=>{try{w.val=!0,console.log("Mounting app..."),y.add(document.getElementById("app"),Ve()),await new Promise(t=>setTimeout(t,100)),console.log("Loading data..."),await xe();const e=new URLSearchParams(window.location.search);if(e.get("shared")==="true"?(console.log("App opened with shared files, processing..."),await N(),window.history.replaceState({},document.title,window.location.pathname)):e.get("error")==="share_failed"?(console.error("Share operation failed"),alert("Failed to share files to the app. Please try again."),window.history.replaceState({},document.title,window.location.pathname)):await N(),console.log(`App initialized with ${u.val.length} files`),u.val.length>0)try{const t=localStorage.getItem("lastPlayedFileId");if(t){console.log(`Found lastPlayedFileId: ${t}`);const o=u.val.find(r=>r.id===t);o?(console.log("Attempting to autoplay last played file:",o),z(o)):console.log("Last played file ID found, but file not in current media list.")}}catch(t){console.warn("Could not retrieve or play lastPlayedFileId:",t)}u.val.length>0&&console.log("Files found, showing sidebar")}catch(e){console.error("Error initializing app:",e),w.val=!1}})();
