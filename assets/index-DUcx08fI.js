(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function r(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(a){if(a.ep)return;a.ep=!0;const n=r(a);fetch(a.href,n)}})();let v=Object.getPrototypeOf,$,I,m,E,Q={isConnected:1},me=1e3,j,W={},pe=v(Q),Z=v(v),F,ee=(e,t,r,o)=>(e??(setTimeout(r,o),new Set)).add(t),te=(e,t,r)=>{let o=m;m=t;try{return e(r)}catch(a){return console.error(a),r}finally{m=o}},T=e=>e.filter(t=>{var r;return(r=t._dom)==null?void 0:r.isConnected}),re=e=>j=ee(j,e,()=>{for(let t of j)t._bindings=T(t._bindings),t._listeners=T(t._listeners);j=F},me),V={get val(){var e;return(e=m==null?void 0:m._getters)==null||e.add(this),this.rawVal},get oldVal(){var e;return(e=m==null?void 0:m._getters)==null||e.add(this),this._oldVal},set val(e){var t;(t=m==null?void 0:m._setters)==null||t.add(this),e!==this.rawVal&&(this.rawVal=e,this._bindings.length+this._listeners.length?(I==null||I.add(this),$=ee($,this,he)):this._oldVal=e)}},oe=e=>({__proto__:V,rawVal:e,_oldVal:e,_bindings:[],_listeners:[]}),U=(e,t)=>{let r={_getters:new Set,_setters:new Set},o={f:e},a=E;E=[];let n=te(e,r,t);n=(n??document).nodeType?n:new Text(n);for(let l of r._getters)r._setters.has(l)||(re(l),l._bindings.push(o));for(let l of E)l._dom=n;return E=a,o._dom=n},R=(e,t=oe(),r)=>{let o={_getters:new Set,_setters:new Set},a={f:e,s:t};a._dom=r??(E==null?void 0:E.push(a))??Q,t.val=te(e,o,t.rawVal);for(let n of o._getters)o._setters.has(n)||(re(n),n._listeners.push(a));return t},ae=(e,...t)=>{for(let r of t.flat(1/0)){let o=v(r??0),a=o===V?U(()=>r.val):o===Z?U(r):r;a!=F&&e.append(a)}return e},ne=(e,t,...r)=>{var s;let[{is:o,...a},...n]=v(r[0]??0)===pe?r:[{},...r],l=e?document.createElementNS(e,t,{is:o}):document.createElement(t,{is:o});for(let[f,u]of Object.entries(a)){let h=A=>A?Object.getOwnPropertyDescriptor(A,f)??h(v(A)):F,y=t+","+f,i=W[y]??(W[y]=((s=h(v(l)))==null?void 0:s.set)??0),_=f.startsWith("on")?(A,ge)=>{let H=f.slice(2);l.removeEventListener(H,ge),l.addEventListener(H,A)}:i?i.bind(l):l.setAttribute.bind(l,f),g=v(u??0);f.startsWith("on")||g===Z&&(u=R(u),g=V),g===V?U(()=>(_(u.val,u._oldVal),l)):_(u)}return ae(l,n)},z=e=>({get:(t,r)=>ne.bind(F,e,r)}),le=(e,t)=>t?t!==e&&e.replaceWith(t):e.remove(),he=()=>{let e=0,t=[...$].filter(o=>o.rawVal!==o._oldVal);do{I=new Set;for(let o of new Set(t.flatMap(a=>a._listeners=T(a._listeners))))R(o.f,o.s,o._dom),o._dom=F}while(++e<100&&(t=[...I]).length);let r=[...$].filter(o=>o.rawVal!==o._oldVal);$=F;for(let o of new Set(r.flatMap(a=>a._bindings=T(a._bindings))))le(o._dom,U(o.f,o._dom)),o._dom=F;for(let o of r)o._oldVal=o.rawVal};const d={tags:new Proxy(e=>new Proxy(ne,z(e)),z()),hydrate:(e,t)=>le(e,U(t,e)),add:ae,state:oe,derive:R},ye="modulepreload",we=function(e){return"/"+e},J={},ve=function(t,r,o){let a=Promise.resolve();if(r&&r.length>0){let l=function(u){return Promise.all(u.map(h=>Promise.resolve(h).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),f=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));a=l(r.map(u=>{if(u=we(u),u in J)return;J[u]=!0;const h=u.endsWith(".css"),y=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${y}`))return;const i=document.createElement("link");if(i.rel=h?"stylesheet":ye,h||(i.as="script"),i.crossOrigin="",i.href=u,f&&i.setAttribute("nonce",f),document.head.appendChild(i),h)return new Promise((_,g)=>{i.addEventListener("load",_),i.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${u}`)))})}))}function n(l){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=l,window.dispatchEvent(s),!s.defaultPrevented)throw l}return a.then(l=>{for(const s of l||[])s.status==="rejected"&&n(s.reason);return t().catch(n)})};function be(e={}){const{immediate:t=!1,onNeedRefresh:r,onOfflineReady:o,onRegistered:a,onRegisteredSW:n,onRegisterError:l}=e;let s,f,u;const h=async(i=!0)=>{await f,u==null||u()};async function y(){if("serviceWorker"in navigator){if(s=await ve(async()=>{const{Workbox:i}=await import("./workbox-window.prod.es5-CwtvwXb3.js");return{Workbox:i}},[]).then(({Workbox:i})=>new i("/sw.js",{scope:"/",type:"classic"})).catch(i=>{l==null||l(i)}),!s)return;u=()=>{s==null||s.messageSkipWaiting()};{let i=!1;const _=()=>{i=!0,s==null||s.addEventListener("controlling",g=>{g.isUpdate&&window.location.reload()}),r==null||r()};s.addEventListener("installed",g=>{typeof g.isUpdate>"u"?typeof g.isExternal<"u"&&g.isExternal?_():!i&&(o==null||o()):g.isUpdate||o==null||o()}),s.addEventListener("waiting",_)}s.register({immediate:t}).then(i=>{n?n("/sw.js",i):a==null||a(i)}).catch(i=>{l==null||l(i)})}}return f=y(),h}const S=d.state(localStorage.getItem("debugMode")==="true"||window.location.hash==="#debug"),O=d.state(!1),D=d.state([]),_e=200,Se={log:console.log,error:console.error,warn:console.warn,info:console.info};function se(e,t){const r=new Date().toLocaleTimeString(),o=t.map(n=>{if(typeof n=="object")try{return JSON.stringify(n,null,2)}catch{return String(n)}return String(n)}).join(" "),a=[...D.val,{timestamp:r,level:e,message:o}];a.length>_e&&a.shift(),D.val=a}["log","error","warn","info"].forEach(e=>{console[e]=function(...t){Se[e].apply(console,t),se(e,t)}});var K;(K=navigator.serviceWorker)==null||K.addEventListener("message",e=>{e.data&&e.data.type==="SW_LOG"&&se(e.data.level,[e.data.message])});function P(e){if(console.error(e),S.val)throw e}function q(e,t={}){const r=e instanceof Error?`${e.name}: ${e.message}

${e.stack||""}`:String(e),o=["context","filename","lineno","colno","reason"].filter(a=>t[a]).map(a=>`${a}: ${t[a]}`).join(`
`);document.body.innerHTML=`<pre style="background:white;color:black;padding:20px;margin:0;white-space:pre-wrap;height:100%;overflow:auto;font-family:monospace">APPLICATION ERROR

${r}

${o}</pre>`}window.onerror=function(e,t,r,o,a){return q(a||new Error(e),{filename:t,lineno:r,colno:o,message:e}),!0};window.addEventListener("unhandledrejection",function(e){q(e.reason instanceof Error?e.reason:new Error(String(e.reason)),{reason:e.reason,promise:e.promise}),e.preventDefault()});let ie=()=>Promise.resolve(!1);"serviceWorker"in navigator&&window.addEventListener("load",()=>{ie=be({immediate:!1})});const{div:c,header:Ee,main:Fe,aside:Le,h1:Pe,h2:ce,button:w,input:ke,label:Ae,span:x,dialog:Oe,ul:$e,li:Ie,p:De,a:de,img:Ue}=d.tags,p=d.state([]),C=d.state(!1),L=d.state(!0),N=d.state(!1),b=new Map;function Ce(e){return b.has(e.id)||b.set(e.id,URL.createObjectURL(e.file)),b.get(e.id)}function Be(e){b.has(e)&&(URL.revokeObjectURL(b.get(e)),b.delete(e))}function B(){return new Promise((e,t)=>{if(!("indexedDB"in window))return t(new Error("IndexedDB is not supported"));const r=indexedDB.open("localfilesDB",2);r.onupgradeneeded=o=>{const a=o.target.result;a.objectStoreNames.contains("mediaFiles")||a.createObjectStore("mediaFiles",{keyPath:"id"}),a.objectStoreNames.contains("sharedFiles")||a.createObjectStore("sharedFiles",{keyPath:"id"})},r.onsuccess=o=>e(o.target.result),r.onerror=o=>{alert(`Database error: ${o.target.error.message}`),t(o.target.error)}})}function k(e,t,r,o){return new Promise((a,n)=>{if(!e)return n(new Error("Database not initialized"));const l=o(e.transaction(t,r).objectStore(t));l.onsuccess=()=>a(l.result),l.onerror=s=>n(s.target.error)})}const je=(e,t,r)=>k(e,"mediaFiles","readwrite",o=>o.put({id:t,blob:r})),xe=(e,t)=>k(e,"mediaFiles","readonly",r=>r.get(t)).then(r=>r?r.blob:null),Te=(e,t)=>k(e,"mediaFiles","readwrite",r=>r.delete(t)),Ve=e=>k(e,"mediaFiles","readwrite",t=>t.clear()),Me=e=>k(e,"sharedFiles","readonly",t=>t.getAll()).then(t=>t||[]),We=e=>k(e,"sharedFiles","readwrite",t=>t.clear());async function X(){try{const e=await B(),t=await Me(e);return t.length===0?!1:(await fe(t.map(r=>r.file)),await We(e),alert(`${t.length} shared file(s) added to your library!`),!0)}catch(e){return console.error("Error processing shared files:",e),P(e),!1}}const ue="localFilesAppMetadata";function Ne(){try{return JSON.parse(localStorage.getItem(ue))||[]}catch{return[]}}function M(e){try{localStorage.setItem(ue,JSON.stringify(e.map(({file:t,...r})=>r)))}catch(t){t.name==="QuotaExceededError"&&alert("Storage full. Clear some browser data.")}}const Re=async()=>{try{L.val=!0;const e=await B(),t=Ne(),r=(await Promise.all(t.map(async o=>{const a=await xe(e,o.id);return a?{...o,file:a}:null}))).filter(Boolean);p.val=r,L.val=!1}catch(e){console.error("Error loading data:",e),P(e),L.val=!1}};async function fe(e){if(!(e!=null&&e.length))return;const t=1e3*1024*1024,r=await B(),o=[];for(let a=0;a<e.length;a++){const n=e[a];if(n.size>t){alert(`File ${n.name} exceeds 1000MB limit.`);continue}const l={id:`file-${Date.now()}-${a}`,name:n.name||`shared-${Date.now()}-${a}`,type:n.type,size:n.size,file:n,progress:0,dateAdded:new Date().toISOString()};try{await je(r,l.id,l.file),o.push(l)}catch(s){console.error("Error storing file in IndexedDB:",s),P(s),alert(`Could not save ${l.name}`)}}if(o.length>0){const a=[...p.val,...o];p.val=a,M(a),C.val=!0,alert(`${o.length} files uploaded!`),setTimeout(()=>G(o[0]),500)}}function G(e){var t;try{const r=document.getElementById("media-player");if(!r)return console.error("Media player element not found"),alert("Media player not found. Refresh the page.");document.getElementById("video-container").style.display="block",(t=document.querySelector(".upload-prompt"))==null||t.style.setProperty("display","none");const o=e.file instanceof File?Ce(e):e.data;if(!o)return console.error("File has no playable source:",e),alert(`Cannot play ${e.name}: Invalid source`);r.src=o,r.setAttribute("data-current-file-id",e.id),e.progress&&(r.currentTime=e.progress),window.innerWidth<768&&(C.val=!1),setTimeout(()=>{r.play().then(()=>localStorage.setItem("lastPlayedFileId",e.id)).catch(console.error)},300)}catch(r){P(r),alert(`Error playing file: ${r.message}`)}}async function qe(e){Be(e);try{const r=await B();await Te(r,e)}catch(r){console.error("Error removing file from IndexedDB:",r),P(r)}const t=p.val.filter(r=>r.id!==e);p.val=t,M(t)}function Ge(){document.getElementById("confirm-dialog").showModal()}async function He(){b.forEach(e=>URL.revokeObjectURL(e)),b.clear();try{await Ve(await B())}catch(e){console.error("Error clearing IndexedDB:",e),P(e)}M([]),p.val=[],document.getElementById("confirm-dialog").close()}function ze(){document.getElementById("confirm-dialog").close()}async function Je(){N.val=!0,await ie(!0).catch(e=>console.error("Update error:",e)),window.location.reload()}function Y(e,t){const r=p.val.map(o=>o.id===e?{...o,progress:t}:o);p.val=r,M(r)}function Xe(){return Le({class:d.derive(()=>`sidebar ${C.val?"open":""}`)},ce({},"Your Files"),d.derive(()=>L.val?c({class:"loading-message"},"Loading files..."):p.val.length===0?c({class:"empty-message"},"No files added yet"):c({},$e({},...p.val.map(e=>Ie({class:"file-item"},x({onclick:()=>G(e),class:"file-name"},e.name||"Unnamed"),w({class:"delete-btn outline",onclick:t=>{t.stopPropagation(),qe(e.id)}},"×")))),w({class:"delete-all-btn outline",onclick:Ge},"Delete All"))),c({class:"sidebar-footer"},c({class:"sidebar-footer-buttons"},w({class:d.derive(()=>`debug-toggle ${S.val?"active":""}`),onclick:()=>{S.val=!S.val,localStorage.setItem("debugMode",S.val)}},d.derive(()=>S.val?"Debug: ON":"Debug: OFF")),w({class:"force-update-btn",onclick:Je,disabled:d.derive(()=>N.val)},d.derive(()=>N.val?"Checking...":"Check for Updates"))),de({href:"https://github.com/netanel-haber/localfiles.stream/commit/69292a456d432fe86f94a763df095ae740501da1",target:"_blank",class:"commit-link"},"69292a456d432fe86f94a763df095ae740501da1".substring(0,7))))}function Ye(){return Ee({},c(w({class:"hamburger outline",onclick:()=>C.val=!C.val},"☰"),Pe({},"localfiles.stream"),c({class:"github-link"},de({href:"https://github.com/netanel-haber/localfiles.stream",target:"_blank"},Ue({src:"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",alt:"GitHub"})))),c(Ae({class:"upload-btn",for:"file-upload"},"Upload Files"),ke({type:"file",id:"file-upload",accept:"audio/*,video/*",multiple:!0,style:"display: none",onchange:async e=>{var t;(t=e.target.files)!=null&&t.length&&await fe(e.target.files),e.target.value=""}})))}function Ke(){return c({class:"media-container"},c({class:"player-wrapper"},c({class:"upload-prompt",style:d.derive(()=>!L.val&&p.val.length===0?"display: flex":"display: none")},"Upload media files to start playing"),c({class:"loading-indicator",style:d.derive(()=>L.val?"display: flex":"display: none")},"Loading your media files..."),c({id:"video-container",class:"video-container",style:"display: none;"},c({class:"media-element-container"},d.tags.video({id:"media-player",controls:!0,playsinline:!0,ontimeupdate:e=>{const t=e.target.getAttribute("data-current-file-id");t&&Y(t,e.target.currentTime)},onended:e=>{const t=e.target.getAttribute("data-current-file-id");t&&Number.isFinite(e.target.duration)&&Y(t,e.target.duration),e.target.removeAttribute("data-current-file-id")},onerror:e=>{var t;alert(`Error playing: ${((t=e.target.error)==null?void 0:t.message)||"Unknown error"}`),e.target.removeAttribute("data-current-file-id")}})))),Ze())}function Qe(){return Oe({id:"confirm-dialog"},c({class:"dialog-content"},ce({},"Confirm Deletion"),De({},"Are you sure you want to delete all files?"),c({class:"dialog-buttons"},w({onclick:ze,class:"secondary"},"Cancel"),w({onclick:He},"Delete All"))))}function Ze(){return c({class:d.derive(()=>`console-viewer ${S.val?"":"hidden"} ${O.val?"open":"closed"}`)},c({class:"console-header"},d.derive(()=>x({},`Console (${D.val.length})`)),c({class:"console-controls"},w({class:"console-btn",onclick:()=>D.val=[]},"Clear"),w({class:"console-btn",onclick:()=>O.val=!O.val},d.derive(()=>O.val?"▼":"▲")))),d.derive(()=>O.val?(setTimeout(()=>{const e=document.getElementById("console-logs-container");e&&(e.scrollTop=e.scrollHeight)},10),c({class:"console-logs",id:"console-logs-container"},...D.val.map(e=>c({class:`console-entry console-${e.level}`},x({class:"console-timestamp"},e.timestamp),x({class:"console-level"},e.level.toUpperCase()),d.tags.pre({class:"console-message"},e.message))))):c({class:"console-logs",style:"display: none;"})))}function et(){return c({id:"layout"},Ye(),c({class:"content"},Xe(),Fe({},Ke())),Qe())}(async()=>{d.add(document.getElementById("app"),et()),await Re();const e=new URLSearchParams(window.location.search);if(e.get("shared")==="true")await X(),window.history.replaceState({},document.title,window.location.pathname);else if(e.get("error")==="share_failed"){const o=new Error(e.get("error_msg")||"Share failed");o.name=e.get("error_name")||"ShareError",q(o,{context:"Android share"}),window.history.replaceState({},document.title,window.location.pathname)}else await X();const t=localStorage.getItem("lastPlayedFileId"),r=t&&p.val.find(o=>o.id===t);r&&G(r)})();
