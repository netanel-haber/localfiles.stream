(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function a(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=a(n);fetch(n.href,o)}})();let v=Object.getPrototypeOf,O,$,m,E,Q={isConnected:1},me=1e3,T,W={},pe=v(Q),Z=v(v),F,ee=(e,t,a,r)=>(e??(setTimeout(a,r),new Set)).add(t),te=(e,t,a)=>{let r=m;m=t;try{return e(a)}catch(n){return console.error(n),a}finally{m=r}},V=e=>e.filter(t=>{var a;return(a=t._dom)==null?void 0:a.isConnected}),re=e=>T=ee(T,e,()=>{for(let t of T)t._bindings=V(t._bindings),t._listeners=V(t._listeners);T=F},me),x={get val(){var e;return(e=m==null?void 0:m._getters)==null||e.add(this),this.rawVal},get oldVal(){var e;return(e=m==null?void 0:m._getters)==null||e.add(this),this._oldVal},set val(e){var t;(t=m==null?void 0:m._setters)==null||t.add(this),e!==this.rawVal&&(this.rawVal=e,this._bindings.length+this._listeners.length?($==null||$.add(this),O=ee(O,this,he)):this._oldVal=e)}},ae=e=>({__proto__:x,rawVal:e,_oldVal:e,_bindings:[],_listeners:[]}),U=(e,t)=>{let a={_getters:new Set,_setters:new Set},r={f:e},n=E;E=[];let o=te(e,a,t);o=(o??document).nodeType?o:new Text(o);for(let l of a._getters)a._setters.has(l)||(re(l),l._bindings.push(r));for(let l of E)l._dom=o;return E=n,r._dom=o},R=(e,t=ae(),a)=>{let r={_getters:new Set,_setters:new Set},n={f:e,s:t};n._dom=a??(E==null?void 0:E.push(n))??Q,t.val=te(e,r,t.rawVal);for(let o of r._getters)r._setters.has(o)||(re(o),o._listeners.push(n));return t},ne=(e,...t)=>{for(let a of t.flat(1/0)){let r=v(a??0),n=r===x?U(()=>a.val):r===Z?U(a):a;n!=F&&e.append(n)}return e},oe=(e,t,...a)=>{var s;let[{is:r,...n},...o]=v(a[0]??0)===pe?a:[{},...a],l=e?document.createElementNS(e,t,{is:r}):document.createElement(t,{is:r});for(let[f,u]of Object.entries(n)){let h=k=>k?Object.getOwnPropertyDescriptor(k,f)??h(v(k)):F,y=t+","+f,i=W[y]??(W[y]=((s=h(v(l)))==null?void 0:s.set)??0),_=f.startsWith("on")?(k,ge)=>{let H=f.slice(2);l.removeEventListener(H,ge),l.addEventListener(H,k)}:i?i.bind(l):l.setAttribute.bind(l,f),g=v(u??0);f.startsWith("on")||g===Z&&(u=R(u),g=x),g===x?U(()=>(_(u.val,u._oldVal),l)):_(u)}return ne(l,o)},z=e=>({get:(t,a)=>oe.bind(F,e,a)}),le=(e,t)=>t?t!==e&&e.replaceWith(t):e.remove(),he=()=>{let e=0,t=[...O].filter(r=>r.rawVal!==r._oldVal);do{$=new Set;for(let r of new Set(t.flatMap(n=>n._listeners=V(n._listeners))))R(r.f,r.s,r._dom),r._dom=F}while(++e<100&&(t=[...$]).length);let a=[...O].filter(r=>r.rawVal!==r._oldVal);O=F;for(let r of new Set(a.flatMap(n=>n._bindings=V(n._bindings))))le(r._dom,U(r.f,r._dom)),r._dom=F;for(let r of a)r._oldVal=r.rawVal};const d={tags:new Proxy(e=>new Proxy(oe,z(e)),z()),hydrate:(e,t)=>le(e,U(t,e)),add:ne,state:ae,derive:R},ye="modulepreload",we=function(e){return"/"+e},J={},ve=function(t,a,r){let n=Promise.resolve();if(a&&a.length>0){let l=function(u){return Promise.all(u.map(h=>Promise.resolve(h).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),f=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));n=l(a.map(u=>{if(u=we(u),u in J)return;J[u]=!0;const h=u.endsWith(".css"),y=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${y}`))return;const i=document.createElement("link");if(i.rel=h?"stylesheet":ye,h||(i.as="script"),i.crossOrigin="",i.href=u,f&&i.setAttribute("nonce",f),document.head.appendChild(i),h)return new Promise((_,g)=>{i.addEventListener("load",_),i.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${u}`)))})}))}function o(l){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=l,window.dispatchEvent(s),!s.defaultPrevented)throw l}return n.then(l=>{for(const s of l||[])s.status==="rejected"&&o(s.reason);return t().catch(o)})};function be(e={}){const{immediate:t=!1,onNeedRefresh:a,onOfflineReady:r,onRegistered:n,onRegisteredSW:o,onRegisterError:l}=e;let s,f,u;const h=async(i=!0)=>{await f,u==null||u()};async function y(){if("serviceWorker"in navigator){if(s=await ve(async()=>{const{Workbox:i}=await import("./workbox-window.prod.es5-CwtvwXb3.js");return{Workbox:i}},[]).then(({Workbox:i})=>new i("/sw.js",{scope:"/",type:"classic"})).catch(i=>{l==null||l(i)}),!s)return;u=()=>{s==null||s.messageSkipWaiting()};{let i=!1;const _=()=>{i=!0,s==null||s.addEventListener("controlling",g=>{g.isUpdate&&window.location.reload()}),a==null||a()};s.addEventListener("installed",g=>{typeof g.isUpdate>"u"?typeof g.isExternal<"u"&&g.isExternal?_():!i&&(r==null||r()):g.isUpdate||r==null||r()}),s.addEventListener("waiting",_)}s.register({immediate:t}).then(i=>{o?o("/sw.js",i):n==null||n(i)}).catch(i=>{l==null||l(i)})}}return f=y(),h}const S=d.state(localStorage.getItem("debugMode")==="true"||window.location.hash==="#debug"),A=d.state(!1),I=d.state([]),_e=200,Se={log:console.log,error:console.error,warn:console.warn,info:console.info};function se(e,t){const a=new Date().toLocaleTimeString(),r=t.map(o=>{if(typeof o=="object")try{return JSON.stringify(o,null,2)}catch{return String(o)}return String(o)}).join(" "),n=[...I.val,{timestamp:a,level:e,message:r}];n.length>_e&&n.shift(),I.val=n}["log","error","warn","info"].forEach(e=>{console[e]=function(...t){Se[e].apply(console,t),se(e,t)}});var K;(K=navigator.serviceWorker)==null||K.addEventListener("message",e=>{e.data&&e.data.type==="SW_LOG"&&se(e.data.level,[e.data.message])});function D(e){if(console.error(e),S.val)throw e}function q(e,t={}){const a=e instanceof Error?`${e.name}: ${e.message}

${e.stack||""}`:String(e),r=["context","filename","lineno","colno","reason"].filter(n=>t[n]).map(n=>`${n}: ${t[n]}`).join(`
`);document.body.innerHTML=`<pre style="background:white;color:black;padding:20px;margin:0;white-space:pre-wrap;height:100%;overflow:auto;font-family:monospace">APPLICATION ERROR

${a}

${r}</pre>`}window.onerror=function(e,t,a,r,n){return q(n||new Error(e),{filename:t,lineno:a,colno:r,message:e}),!0};window.addEventListener("unhandledrejection",function(e){q(e.reason instanceof Error?e.reason:new Error(String(e.reason)),{reason:e.reason,promise:e.promise}),e.preventDefault()});let ie=()=>Promise.resolve(!1);"serviceWorker"in navigator&&window.addEventListener("load",()=>{ie=be({immediate:!1})});const{div:c,header:Ee,main:Fe,aside:Le,h1:Pe,h2:ce,button:w,input:ke,label:Ae,span:B,dialog:Oe,ul:$e,li:Ie,p:Ue,a:de,img:Ce}=d.tags,p=d.state([]),C=d.state(!1),L=d.state(!0),N=d.state(!1),b=new Map;function De(e){return b.has(e.id)||b.set(e.id,URL.createObjectURL(e.file)),b.get(e.id)}function je(e){b.has(e)&&(URL.revokeObjectURL(b.get(e)),b.delete(e))}function j(){return new Promise((e,t)=>{if(!("indexedDB"in window))return t(new Error("IndexedDB is not supported"));const a=indexedDB.open("localfilesDB",2);a.onupgradeneeded=r=>{const n=r.target.result;n.objectStoreNames.contains("mediaFiles")||n.createObjectStore("mediaFiles",{keyPath:"id"}),n.objectStoreNames.contains("sharedFiles")||n.createObjectStore("sharedFiles",{keyPath:"id"})},a.onsuccess=r=>e(r.target.result),a.onerror=r=>{alert(`Database error: ${r.target.error.message}`),t(r.target.error)}})}function P(e,t,a,r){return new Promise((n,o)=>{if(!e)return o(new Error("Database not initialized"));const l=r(e.transaction(t,a).objectStore(t));l.onsuccess=()=>n(l.result),l.onerror=s=>o(s.target.error)})}const Te=(e,t,a)=>P(e,"mediaFiles","readwrite",r=>r.put({id:t,blob:a})),Be=(e,t)=>P(e,"mediaFiles","readonly",a=>a.get(t)).then(a=>a?a.blob:null),Ve=(e,t)=>P(e,"mediaFiles","readwrite",a=>a.delete(t)),xe=e=>P(e,"mediaFiles","readwrite",t=>t.clear()),Me=e=>P(e,"sharedFiles","readonly",t=>t.getAll()).then(t=>t||[]),We=e=>P(e,"sharedFiles","readwrite",t=>t.clear());async function X(){try{const e=await j(),t=await Me(e);return t.length===0?!1:(await fe(t.map(a=>a.file)),await We(e),alert(`${t.length} shared file(s) added to your library!`),!0)}catch(e){return D(e),!1}}const ue="localFilesAppMetadata";function Ne(){try{return JSON.parse(localStorage.getItem(ue))||[]}catch{return[]}}function M(e){try{localStorage.setItem(ue,JSON.stringify(e.map(({file:t,...a})=>a)))}catch(t){t.name==="QuotaExceededError"&&alert("Storage full. Clear some browser data.")}}const Re=async()=>{try{L.val=!0;const e=await j(),t=Ne(),a=(await Promise.all(t.map(async r=>{const n=await Be(e,r.id);return n?{...r,file:n}:null}))).filter(Boolean);p.val=a,L.val=!1}catch(e){D(e),L.val=!1}};async function fe(e){if(!(e!=null&&e.length))return;const t=1e3*1024*1024,a=await j(),r=[];for(let n=0;n<e.length;n++){const o=e[n];if(o.size>t){alert(`File ${o.name} exceeds 1000MB limit.`);continue}const l={id:`file-${Date.now()}-${n}`,name:o.name||`shared-${Date.now()}-${n}`,type:o.type,size:o.size,file:o,progress:0,dateAdded:new Date().toISOString()};try{await Te(a,l.id,l.file),r.push(l)}catch(s){D(s),alert(`Could not save ${l.name}`)}}if(r.length>0){const n=[...p.val,...r];p.val=n,M(n),C.val=!0,alert(`${r.length} files uploaded!`),setTimeout(()=>G(r[0]),500)}}function G(e){var r;const t=document.getElementById("media-player");if(!t)return alert("Media player not found. Refresh the page.");document.getElementById("video-container").style.display="block",(r=document.querySelector(".upload-prompt"))==null||r.style.setProperty("display","none");const a=e.file instanceof File?De(e):e.data;if(!a)return alert(`Cannot play ${e.name}: Invalid source`);t.src=a,t.setAttribute("data-current-file-id",e.id),e.progress&&(t.currentTime=e.progress),window.innerWidth<768&&(C.val=!1),setTimeout(()=>{t.play().then(()=>localStorage.setItem("lastPlayedFileId",e.id)).catch(()=>{})},300)}async function qe(e){je(e);try{const a=await j();await Ve(a,e)}catch(a){D(a)}const t=p.val.filter(a=>a.id!==e);p.val=t,M(t)}function Ge(){document.getElementById("confirm-dialog").showModal()}async function He(){b.forEach(e=>URL.revokeObjectURL(e)),b.clear();try{await xe(await j())}catch(e){D(e)}M([]),p.val=[],document.getElementById("confirm-dialog").close()}function ze(){document.getElementById("confirm-dialog").close()}async function Je(){N.val=!0,await ie(!0).catch(()=>{}),window.location.reload()}function Y(e,t){const a=p.val.map(r=>r.id===e?{...r,progress:t}:r);p.val=a,M(a)}function Xe(){return Le({class:d.derive(()=>`sidebar ${C.val?"open":""}`)},ce({},"Your Files"),d.derive(()=>L.val?c({class:"loading-message"},"Loading files..."):p.val.length===0?c({class:"empty-message"},"No files added yet"):c({},$e({},...p.val.map(e=>Ie({class:"file-item"},B({onclick:()=>G(e),class:"file-name"},e.name||"Unnamed"),w({class:"delete-btn outline",onclick:t=>{t.stopPropagation(),qe(e.id)}},"×")))),w({class:"delete-all-btn outline",onclick:Ge},"Delete All"))),c({class:"sidebar-footer"},c({class:"sidebar-footer-buttons"},w({class:d.derive(()=>`debug-toggle ${S.val?"active":""}`),onclick:()=>{S.val=!S.val,localStorage.setItem("debugMode",S.val)}},d.derive(()=>S.val?"Debug: ON":"Debug: OFF")),w({class:"force-update-btn",onclick:Je,disabled:d.derive(()=>N.val)},d.derive(()=>N.val?"Checking...":"Check for Updates"))),de({href:"https://github.com/netanel-haber/localfiles.stream/commit/5dc7cf9f2089196a3c6877dbf30b99782ee03ddb",target:"_blank",class:"commit-link"},"5dc7cf9f2089196a3c6877dbf30b99782ee03ddb".substring(0,7))))}function Ye(){return Ee({},c(w({class:"hamburger outline",onclick:()=>C.val=!C.val},"☰"),Pe({},"localfiles.stream"),c({class:"github-link"},de({href:"https://github.com/netanel-haber/localfiles.stream",target:"_blank"},Ce({src:"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",alt:"GitHub"})))),c(Ae({class:"upload-btn",for:"file-upload"},"Upload Files"),ke({type:"file",id:"file-upload",accept:"audio/*,video/*",multiple:!0,style:"display: none",onchange:async e=>{var t;(t=e.target.files)!=null&&t.length&&await fe(e.target.files),e.target.value=""}})))}function Ke(){return c({class:"media-container"},c({class:"player-wrapper"},c({class:"upload-prompt",style:d.derive(()=>!L.val&&p.val.length===0?"display: flex":"display: none")},"Upload media files to start playing"),c({class:"loading-indicator",style:d.derive(()=>L.val?"display: flex":"display: none")},"Loading your media files..."),c({id:"video-container",class:"video-container",style:"display: none;"},c({class:"media-element-container"},d.tags.video({id:"media-player",controls:!0,playsinline:!0,ontimeupdate:e=>{const t=e.target.getAttribute("data-current-file-id");t&&Y(t,e.target.currentTime)},onended:e=>{const t=e.target.getAttribute("data-current-file-id");t&&Number.isFinite(e.target.duration)&&Y(t,e.target.duration),e.target.removeAttribute("data-current-file-id")},onerror:e=>{var t;alert(`Error playing: ${((t=e.target.error)==null?void 0:t.message)||"Unknown error"}`),e.target.removeAttribute("data-current-file-id")}})))),Ze())}function Qe(){return Oe({id:"confirm-dialog"},c({class:"dialog-content"},ce({},"Confirm Deletion"),Ue({},"Are you sure you want to delete all files?"),c({class:"dialog-buttons"},w({onclick:ze,class:"secondary"},"Cancel"),w({onclick:He},"Delete All"))))}function Ze(){return c({class:d.derive(()=>`console-viewer ${S.val?"":"hidden"} ${A.val?"open":"closed"}`)},c({class:"console-header"},d.derive(()=>B({},`Console (${I.val.length})`)),c({class:"console-controls"},w({class:"console-btn",onclick:()=>I.val=[]},"Clear"),w({class:"console-btn",onclick:()=>A.val=!A.val},d.derive(()=>A.val?"▼":"▲")))),d.derive(()=>A.val?(setTimeout(()=>{const e=document.getElementById("console-logs-container");e&&(e.scrollTop=e.scrollHeight)},10),c({class:"console-logs",id:"console-logs-container"},...I.val.map(e=>c({class:`console-entry console-${e.level}`},B({class:"console-timestamp"},e.timestamp),B({class:"console-level"},e.level.toUpperCase()),d.tags.pre({class:"console-message"},e.message))))):c({class:"console-logs",style:"display: none;"})))}function et(){return c({id:"layout"},Ye(),c({class:"content"},Xe(),Fe({},Ke())),Qe())}(async()=>{d.add(document.getElementById("app"),et()),await Re();const e=new URLSearchParams(window.location.search);if(e.get("shared")==="true")await X(),window.history.replaceState({},document.title,window.location.pathname);else if(e.get("error")==="share_failed"){const r=new Error(e.get("error_msg")||"Share failed");r.name=e.get("error_name")||"ShareError",q(r,{context:"Android share"}),window.history.replaceState({},document.title,window.location.pathname)}else await X();const t=localStorage.getItem("lastPlayedFileId"),a=t&&p.val.find(r=>r.id===t);a&&G(a)})();
